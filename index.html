<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè† Alquileres Miami</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 240px;
            height: 100vh;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        .logo { font-size: 1.5rem; font-weight: 700; color: #4ecdc4; margin-bottom: 40px; }
        .nav-item {
            padding: 12px 16px;
            margin: 5px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-item:hover, .nav-item.active { background: rgba(78, 205, 196, 0.2); color: #4ecdc4; }
        
        .main { margin-left: 240px; padding: 30px; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header h1 { font-size: 1.8rem; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        
        select, input[type="date"] {
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 0.9rem;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .kpi-card .label { color: #8892b0; font-size: 0.85rem; margin-bottom: 8px; }
        .kpi-card .value { font-size: 2rem; font-weight: 700; color: #4ecdc4; }
        .kpi-card .sub { color: #8892b0; font-size: 0.8rem; margin-top: 5px; }
        
        .section { display: none; }
        .section.active { display: block; }
        
        /* Calendar styles */
        .calendar-container { display: grid; grid-template-columns: 200px 1fr; gap: 20px; }
        .property-list { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 15px; }
        .property-item {
            padding: 12px; margin: 5px 0; border-radius: 8px;
            cursor: pointer; border-left: 4px solid transparent;
        }
        .property-item:hover { background: rgba(255,255,255,0.1); }
        .property-item.selected { background: rgba(78,205,196,0.2); border-left-color: #4ecdc4; }
        
        .calendar { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-nav button {
            padding: 8px 16px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: transparent; color: white; cursor: pointer;
        }
        .calendar-nav button:hover { background: rgba(255,255,255,0.1); }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day-header { text-align: center; padding: 10px; color: #8892b0; font-size: 0.85rem; }
        .calendar-day {
            aspect-ratio: 1; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; border: 2px solid transparent;
            background: rgba(0,0,0,0.2); transition: all 0.2s; user-select: none;
        }
        .calendar-day:hover { border-color: rgba(78,205,196,0.5); }
        .calendar-day.empty { background: transparent; cursor: default; }
        .calendar-day.empty:hover { border-color: transparent; }
        .calendar-day .day-num { font-weight: 600; }
        .calendar-day .day-price { font-size: 0.7rem; color: #4ecdc4; }
        .calendar-day.selected-multi { border-color: #fff !important; background: rgba(255,255,255,0.2) !important; }
        .calendar-day.ocupado-due√±o { background: rgba(46,204,113,0.3); border-color: #2ecc71; }
        .calendar-day.ocupado-alicia { background: rgba(155,89,182,0.3); border-color: #9b59b6; }
        .calendar-day.ocupado-estanislao { background: rgba(241,196,15,0.3); border-color: #f1c40f; }
        
        .legend { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .legend-color { width: 20px; height: 20px; border-radius: 5px; }
        
        .selection-bar {
            background: rgba(78,205,196,0.2); border: 1px solid #4ecdc4;
            border-radius: 10px; padding: 15px 20px; margin-top: 20px;
            display: none; align-items: center; justify-content: space-between;
        }
        .selection-bar.show { display: flex; }
        .selection-bar .count { font-weight: 600; color: #4ecdc4; }
        .selection-bar .actions { display: flex; gap: 10px; }
        
        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
        .tab {
            padding: 12px 24px; border-radius: 10px 10px 0 0;
            background: rgba(255,255,255,0.05); cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1); border-bottom: none;
        }
        .tab:hover { background: rgba(255,255,255,0.1); }
        .tab.active { background: rgba(78,205,196,0.2); color: #4ecdc4; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Filters */
        .filters {
            display: flex; gap: 15px; margin-bottom: 20px;
            padding: 15px; background: rgba(255,255,255,0.03);
            border-radius: 10px; flex-wrap: wrap; align-items: center;
        }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { color: #8892b0; font-size: 0.85rem; }
        
        /* Tables */
        .table-container {
            background: rgba(255,255,255,0.05);
            border-radius: 16px; padding: 20px; overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; }
        th {
            text-align: left; padding: 12px 15px;
            background: rgba(78,205,196,0.1); color: #4ecdc4; font-weight: 500;
        }
        td { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        tr:hover { background: rgba(255,255,255,0.03); }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; }
        .badge-due√±o { background: rgba(46,204,113,0.2); color: #2ecc71; }
        .badge-alicia { background: rgba(155,89,182,0.2); color: #9b59b6; }
        .badge-estanislao { background: rgba(241,196,15,0.2); color: #f1c40f; }
        
        .total-row { background: rgba(78,205,196,0.1) !important; font-weight: 600; }
        
        /* Charts */
        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px; }
        .chart-card { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; }
        .chart-card h3 { margin-bottom: 15px; font-size: 1rem; color: #8892b0; }
        
        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.7);
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content { background: #1e3a5f; border-radius: 20px; padding: 30px; width: 450px; max-width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 1.3rem; }
        .modal-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #8892b0; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3); color: white; font-size: 1rem;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #4ecdc4; }
        
        .btn {
            padding: 12px 24px; border-radius: 10px; border: none;
            cursor: pointer; font-size: 1rem; font-weight: 500;
        }
        .btn-primary { background: #4ecdc4; color: #0d1b2a; }
        .btn-primary:hover { background: #3dbdb5; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-success { background: #2ecc71; color: white; }
        
        .origen-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .origen-btn {
            padding: 20px 15px; border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.2);
            background: transparent; color: white; cursor: pointer; text-align: center;
        }
        .origen-btn:hover { border-color: rgba(255,255,255,0.4); }
        .origen-btn.selected { border-width: 3px; }
        .origen-btn.due√±o.selected { border-color: #2ecc71; background: rgba(46,204,113,0.2); }
        .origen-btn.alicia.selected { border-color: #9b59b6; background: rgba(155,89,182,0.2); }
        .origen-btn.estanislao.selected { border-color: #f1c40f; background: rgba(241,196,15,0.2); }
        
        .help-text {
            background: rgba(78,205,196,0.1); border: 1px solid rgba(78,205,196,0.3);
            border-radius: 10px; padding: 15px; margin-bottom: 20px; font-size: 0.9rem;
        }
        
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            padding: 15px 25px; border-radius: 10px;
            background: #2ecc71; color: white; display: none; z-index: 2000;
        }
        .toast.show { display: block; animation: slideIn 0.3s; }
        .toast.error { background: #e74c3c; }
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .summary-card {
            background: rgba(255,255,255,0.05); border-radius: 16px;
            padding: 20px; margin-bottom: 20px;
        }
        .summary-card h3 { color: #4ecdc4; margin-bottom: 15px; font-size: 1.1rem; }
        .summary-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .summary-row:last-child { border-bottom: none; }
        .summary-label { color: #8892b0; }
        .summary-value { font-weight: 600; }
        .summary-value.positive { color: #2ecc71; }
        .summary-value.negative { color: #e74c3c; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">üè† Miami</div>
        <div class="nav-item active" onclick="showSection('dashboard')">üìä Dashboard</div>
        <div class="nav-item" onclick="showSection('ocupacion')">üìÖ Ocupaci√≥n</div>
        <div class="nav-item" onclick="showSection('gastos')">üí∞ Gastos</div>
        <div class="nav-item" onclick="showSection('reportes')">üìà Reportes</div>
    </div>
    
    <div class="main">
        <!-- Dashboard -->
        <div id="dashboard" class="section active">
            <div class="header">
                <h1>Dashboard</h1>
                <div class="header-actions">
                    <select id="yearSelect" onchange="loadAll()">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                    <button class="btn btn-success" onclick="abrirPresentacion()">üéØ Ver Presentaci√≥n</button>
                </div>
            </div>
            
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="label">Ingresos Totales</div>
                    <div class="value" id="kpi-ingresos">$0</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Gastos Totales</div>
                    <div class="value" id="kpi-gastos" style="color:#e74c3c">$0</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Rentabilidad</div>
                    <div class="value" id="kpi-rentabilidad">$0</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Noches Ocupadas</div>
                    <div class="value" id="kpi-noches">0</div>
                    <div class="sub" id="kpi-ocupacion">0% ocupaci√≥n</div>
                </div>
            </div>
            
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>üìä Ingresos por Propiedad</h3>
                    <canvas id="chart-ingresos"></canvas>
                </div>
                <div class="chart-card">
                    <h3>üë• Ingresos por Origen</h3>
                    <canvas id="chart-origen"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Ocupaci√≥n -->
        <div id="ocupacion" class="section">
            <div class="header">
                <h1>üìÖ Cargar Ocupaci√≥n</h1>
            </div>
            
            <div class="help-text">
                üí° <strong>Tip:</strong> Hac√© click en varios d√≠as para seleccionarlos, despu√©s "Cargar selecci√≥n"
            </div>
            
            <div class="calendar-container">
                <div class="property-list">
                    <h3 style="margin-bottom:15px;color:#4ecdc4">Propiedades</h3>
                    <div id="property-list"></div>
                </div>
                
                <div class="calendar">
                    <div class="calendar-header">
                        <button onclick="changeMonth(-1)">‚Üê Anterior</button>
                        <h2 id="calendar-month">Diciembre 2025</h2>
                        <button onclick="changeMonth(1)">Siguiente ‚Üí</button>
                    </div>
                    <div class="calendar-grid" id="calendar-grid"></div>
                    
                    <div class="selection-bar" id="selection-bar">
                        <span><span class="count" id="selected-count">0</span> d√≠as seleccionados</span>
                        <div class="actions">
                            <button class="btn btn-secondary" onclick="clearSelection()">Cancelar</button>
                            <button class="btn btn-primary" onclick="openMultiModal()">Cargar selecci√≥n</button>
                        </div>
                    </div>
                    
                    <div class="legend">
                        <div class="legend-item"><div class="legend-color" style="background:rgba(46,204,113,0.5)"></div><span>Due√±o</span></div>
                        <div class="legend-item"><div class="legend-color" style="background:rgba(155,89,182,0.5)"></div><span>Alicia</span></div>
                        <div class="legend-item"><div class="legend-color" style="background:rgba(241,196,15,0.5)"></div><span>Estanislao</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gastos -->
        <div id="gastos" class="section">
            <div class="header">
                <h1>üí∞ Gastos</h1>
                <button class="btn btn-primary" onclick="openGastoModal()">+ Nuevo Gasto</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Fecha</th><th>Propiedad</th><th>Categor√≠a</th><th>Monto</th><th>Descripci√≥n</th><th></th></tr>
                    </thead>
                    <tbody id="gastos-table"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Reportes -->
        <div id="reportes" class="section">
            <div class="header">
                <h1>üìà Reportes</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="exportarExcel()">üì• Excel</button>
                    <button class="btn btn-success" onclick="abrirPresentacion()">üéØ Presentaci√≥n</button>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('tab-ingresos')">üíµ Ingresos</div>
                <div class="tab" onclick="showTab('tab-gastos')">üí∏ Gastos</div>
                <div class="tab" onclick="showTab('tab-resumen')">üìä Resumen</div>
            </div>
            
            <!-- Tab Ingresos -->
            <div id="tab-ingresos" class="tab-content active">
                <div class="filters">
                    <div class="filter-group">
                        <label>Propiedad:</label>
                        <select id="filter-prop" onchange="filtrarIngresos()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Origen:</label>
                        <select id="filter-origen" onchange="filtrarIngresos()">
                            <option value="">Todos</option>
                            <option value="Due√±o">Due√±o</option>
                            <option value="Alicia">Alicia</option>
                            <option value="Estanislao">Estanislao</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Mes:</label>
                        <select id="filter-mes" onchange="filtrarIngresos()">
                            <option value="">Todos</option>
                            <option value="01">Enero</option>
                            <option value="02">Febrero</option>
                            <option value="03">Marzo</option>
                            <option value="04">Abril</option>
                            <option value="05">Mayo</option>
                            <option value="06">Junio</option>
                            <option value="07">Julio</option>
                            <option value="08">Agosto</option>
                            <option value="09">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                </div>
                
                <div class="summary-card">
                    <h3>üìä Resumen Filtrado</h3>
                    <div class="summary-row">
                        <span class="summary-label">Total Ingresos:</span>
                        <span class="summary-value positive" id="sum-ingresos">$0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Noches:</span>
                        <span class="summary-value" id="sum-noches">0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Ticket Promedio:</span>
                        <span class="summary-value" id="sum-ticket">$0</span>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Fecha</th><th>Propiedad</th><th>Precio</th><th>Origen</th><th>Notas</th></tr>
                        </thead>
                        <tbody id="ingresos-table"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab Gastos -->
            <div id="tab-gastos" class="tab-content">
                <div class="filters">
                    <div class="filter-group">
                        <label>Propiedad:</label>
                        <select id="filter-gasto-prop" onchange="filtrarGastosReporte()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Categor√≠a:</label>
                        <select id="filter-gasto-cat" onchange="filtrarGastosReporte()">
                            <option value="">Todas</option>
                            <option value="Expensas">Expensas</option>
                            <option value="Impuestos">Impuestos</option>
                            <option value="Reparaciones">Reparaciones</option>
                            <option value="Comisiones">Comisiones</option>
                            <option value="Limpieza">Limpieza</option>
                            <option value="Servicios">Servicios</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                </div>
                
                <div class="summary-card">
                    <h3>üí∏ Resumen Filtrado</h3>
                    <div class="summary-row">
                        <span class="summary-label">Total Gastos:</span>
                        <span class="summary-value negative" id="sum-gastos">$0</span>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Fecha</th><th>Propiedad</th><th>Categor√≠a</th><th>Monto</th><th>Descripci√≥n</th></tr>
                        </thead>
                        <tbody id="gastos-reporte-table"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab Resumen -->
            <div id="tab-resumen" class="tab-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Propiedad</th><th>Ingresos</th><th>Gastos</th><th>Rentabilidad</th><th>Noches</th><th>% Ocup</th><th>Ticket</th><th>Due√±o</th><th>Terceros</th></tr>
                        </thead>
                        <tbody id="resumen-table"></tbody>
                    </table>
                </div>
                
                <div class="charts-grid" style="margin-top:30px">
                    <div class="chart-card">
                        <h3>üí∞ Rentabilidad por Propiedad</h3>
                        <canvas id="chart-rent"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>üìä Distribuci√≥n de Ingresos</h3>
                        <canvas id="chart-dist"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Ocupaci√≥n -->
    <div class="modal" id="ocupacion-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Cargar Ocupaci√≥n</h3>
                <button class="modal-close" onclick="closeModal('ocupacion-modal')">&times;</button>
            </div>
            <form id="ocupacion-form">
                <div class="form-group">
                    <label>¬øQui√©n lo alquil√≥?</label>
                    <div class="origen-selector">
                        <button type="button" class="origen-btn due√±o" data-origen="Due√±o" onclick="selectOrigen(this)">üë§<br>Due√±o</button>
                        <button type="button" class="origen-btn alicia" data-origen="Alicia" onclick="selectOrigen(this)">üë©<br>Alicia</button>
                        <button type="button" class="origen-btn estanislao" data-origen="Estanislao" onclick="selectOrigen(this)">üë®<br>Estanislao</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Precio por noche (USD)</label>
                    <input type="number" id="ocup-precio" placeholder="150" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Notas (opcional)</label>
                    <textarea id="ocup-notas" rows="2" placeholder="Ej: Reserva Airbnb"></textarea>
                </div>
                <div style="display:flex;gap:10px">
                    <button type="submit" class="btn btn-primary" style="flex:1">Guardar</button>
                    <button type="button" class="btn btn-danger" onclick="eliminarSeleccion()" id="btn-eliminar" style="display:none">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Gasto -->
    <div class="modal" id="gasto-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Gasto</h3>
                <button class="modal-close" onclick="closeModal('gasto-modal')">&times;</button>
            </div>
            <form id="gasto-form">
                <div class="form-group">
                    <label>Fecha</label>
                    <input type="date" id="gasto-fecha" required>
                </div>
                <div class="form-group">
                    <label>Propiedad (vac√≠o = general)</label>
                    <select id="gasto-propiedad"><option value="">General</option></select>
                </div>
                <div class="form-group">
                    <label>Categor√≠a</label>
                    <select id="gasto-categoria" required>
                        <option value="Expensas">Expensas</option>
                        <option value="Impuestos">Impuestos</option>
                        <option value="Reparaciones">Reparaciones</option>
                        <option value="Comisiones">Comisiones</option>
                        <option value="Limpieza">Limpieza</option>
                        <option value="Servicios">Servicios</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Monto (USD)</label>
                    <input type="number" id="gasto-monto" placeholder="100" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <input type="text" id="gasto-descripcion" placeholder="Ej: Expensas enero">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Guardar</button>
            </form>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        let propiedades = [];
        let selectedProperty = null;
        let currentYear = 2025;
        let currentMonth = 12;
        let ocupaciones = {};
        let selectedOrigen = null;
        let selectedDays = new Set();
        let ingresosData = [];
        let gastosData = [];
        
        document.addEventListener('DOMContentLoaded', () => {
            loadPropiedades();
            loadAll();
            document.getElementById('gasto-fecha').valueAsDate = new Date();
        });
        
        function loadAll() {
            currentYear = parseInt(document.getElementById('yearSelect').value);
            loadDashboard();
            loadGastos();
            loadReportes();
        }
        
        async function loadPropiedades() {
            const res = await fetch('/api/propiedades');
            propiedades = await res.json();
            
            document.getElementById('property-list').innerHTML = propiedades.map(p => `
                <div class="property-item" data-id="${p.id}" onclick="selectProperty(${p.id})">
                    ${p.tipo === 'local' ? 'üè™' : 'üè†'} ${p.nombre}
                </div>
            `).join('');
            
            ['gasto-propiedad', 'filter-prop', 'filter-gasto-prop'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const firstOpt = el.querySelector('option');
                    el.innerHTML = firstOpt ? firstOpt.outerHTML : '';
                    propiedades.forEach(p => {
                        el.innerHTML += `<option value="${p.nombre}">${p.nombre}</option>`;
                    });
                }
            });
            
            if (propiedades.length > 0) selectProperty(propiedades[0].id);
        }
        
        function selectProperty(id) {
            selectedProperty = id;
            clearSelection();
            document.querySelectorAll('.property-item').forEach(el => {
                el.classList.toggle('selected', el.dataset.id == id);
            });
            loadCalendar();
        }
        
        async function loadCalendar() {
            if (!selectedProperty) return;
            const res = await fetch(`/api/ocupaciones/${currentYear}/${currentMonth}`);
            const data = await res.json();
            ocupaciones = {};
            data.forEach(o => { ocupaciones[`${o.propiedad_id}-${o.fecha}`] = o; });
            renderCalendar();
        }
        
        function renderCalendar() {
            const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            document.getElementById('calendar-month').textContent = `${monthNames[currentMonth-1]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const lastDay = new Date(currentYear, currentMonth, 0);
            const startWeekDay = firstDay.getDay();
            const totalDays = lastDay.getDate();
            
            let html = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'].map(d => `<div class="calendar-day-header">${d}</div>`).join('');
            for (let i = 0; i < startWeekDay; i++) html += '<div class="calendar-day empty"></div>';
            
            for (let day = 1; day <= totalDays; day++) {
                const fecha = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const key = `${selectedProperty}-${fecha}`;
                const ocup = ocupaciones[key];
                
                let classes = 'calendar-day';
                let content = `<span class="day-num">${day}</span>`;
                
                if (ocup) {
                    classes += ` ocupado-${ocup.origen.toLowerCase()}`;
                    if (ocup.precio > 0) content += `<span class="day-price">$${ocup.precio}</span>`;
                }
                if (selectedDays.has(fecha)) classes += ' selected-multi';
                
                html += `<div class="${classes}" data-fecha="${fecha}" onclick="toggleDay('${fecha}')">${content}</div>`;
            }
            document.getElementById('calendar-grid').innerHTML = html;
        }
        
        function toggleDay(fecha) {
            selectedDays.has(fecha) ? selectedDays.delete(fecha) : selectedDays.add(fecha);
            updateSelectionBar();
            renderCalendar();
        }
        
        function updateSelectionBar() {
            const bar = document.getElementById('selection-bar');
            document.getElementById('selected-count').textContent = selectedDays.size;
            bar.classList.toggle('show', selectedDays.size > 0);
        }
        
        function clearSelection() {
            selectedDays.clear();
            updateSelectionBar();
            renderCalendar();
        }
        
        function openMultiModal() {
            if (selectedDays.size === 0) return;
            const prop = propiedades.find(p => p.id === selectedProperty);
            const fechas = Array.from(selectedDays).sort();
            
            document.getElementById('modal-title').textContent = fechas.length === 1 ? `${prop.nombre} - ${fechas[0]}` : `${prop.nombre} - ${fechas.length} d√≠as`;
            
            const key = `${selectedProperty}-${fechas[0]}`;
            const ocup = ocupaciones[key];
            
            if (ocup && fechas.length === 1) {
                document.getElementById('ocup-precio').value = ocup.precio;
                document.getElementById('ocup-notas').value = ocup.notas || '';
                document.getElementById('btn-eliminar').style.display = 'block';
                document.querySelectorAll('.origen-btn').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.origen === ocup.origen);
                    if (btn.dataset.origen === ocup.origen) selectedOrigen = ocup.origen;
                });
            } else {
                document.getElementById('ocup-precio').value = '';
                document.getElementById('ocup-notas').value = '';
                document.getElementById('btn-eliminar').style.display = 'none';
                document.querySelectorAll('.origen-btn').forEach(btn => btn.classList.remove('selected'));
                selectedOrigen = null;
            }
            document.getElementById('ocupacion-modal').classList.add('show');
        }
        
        function selectOrigen(btn) {
            document.querySelectorAll('.origen-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedOrigen = btn.dataset.origen;
        }
        
        document.getElementById('ocupacion-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedOrigen) { showToast('Seleccion√° qui√©n lo alquil√≥', 'error'); return; }
            
            const precio = parseFloat(document.getElementById('ocup-precio').value) || 0;
            const notas = document.getElementById('ocup-notas').value;
            let saved = 0;
            
            for (const fecha of selectedDays) {
                const res = await fetch('/api/ocupacion', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ propiedad_id: selectedProperty, fecha, precio, origen: selectedOrigen, notas })
                });
                if (res.ok) saved++;
            }
            
            showToast(`${saved} d√≠as guardados ‚úì`);
            closeModal('ocupacion-modal');
            clearSelection();
            loadCalendar();
            loadAll();
        });
        
        async function eliminarSeleccion() {
            if (!confirm(`¬øEliminar ${selectedDays.size} d√≠a(s)?`)) return;
            for (const fecha of selectedDays) {
                await fetch(`/api/ocupacion/${selectedProperty}/${fecha}`, {method: 'DELETE'});
            }
            showToast('Eliminado');
            closeModal('ocupacion-modal');
            clearSelection();
            loadCalendar();
            loadAll();
        }
        
        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 12) { currentMonth = 1; currentYear++; }
            if (currentMonth < 1) { currentMonth = 12; currentYear--; }
            clearSelection();
            loadCalendar();
        }
        
        async function loadGastos() {
            const res = await fetch(`/api/gastos?year=${currentYear}`);
            const gastos = await res.json();
            document.getElementById('gastos-table').innerHTML = gastos.map(g => `
                <tr>
                    <td>${g.fecha}</td>
                    <td>${g.propiedad_nombre || 'General'}</td>
                    <td>${g.categoria}</td>
                    <td>$${g.monto.toLocaleString()}</td>
                    <td>${g.descripcion || '-'}</td>
                    <td><button class="btn btn-danger" onclick="eliminarGasto(${g.id})" style="padding:5px 10px;font-size:0.8rem">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }
        
        function openGastoModal() { document.getElementById('gasto-modal').classList.add('show'); }
        
        document.getElementById('gasto-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const res = await fetch('/api/gastos', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    fecha: document.getElementById('gasto-fecha').value,
                    propiedad_id: document.getElementById('gasto-propiedad').value || null,
                    categoria: document.getElementById('gasto-categoria').value,
                    monto: parseFloat(document.getElementById('gasto-monto').value),
                    descripcion: document.getElementById('gasto-descripcion').value
                })
            });
            if (res.ok) {
                showToast('Gasto guardado ‚úì');
                closeModal('gasto-modal');
                document.getElementById('gasto-form').reset();
                document.getElementById('gasto-fecha').valueAsDate = new Date();
                loadAll();
            }
        });
        
        async function eliminarGasto(id) {
            if (confirm('¬øEliminar?')) {
                await fetch(`/api/gasto/${id}`, {method: 'DELETE'});
                showToast('Eliminado');
                loadAll();
            }
        }
        
        async function loadDashboard() {
            const res = await fetch(`/api/resumen/${currentYear}`);
            const data = await res.json();
            
            let totalIngresos = 0, totalNoches = 0, ingresosPorOrigen = {}, ingresosPorPropiedad = {};
            data.ingresos.forEach(i => {
                totalIngresos += i.total_ingresos;
                totalNoches += i.noches;
                ingresosPorOrigen[i.origen] = (ingresosPorOrigen[i.origen] || 0) + i.total_ingresos;
                ingresosPorPropiedad[i.nombre] = (ingresosPorPropiedad[i.nombre] || 0) + i.total_ingresos;
            });
            
            let totalGastos = data.gastos_generales;
            data.gastos.forEach(g => totalGastos += g.total_gastos);
            
            document.getElementById('kpi-ingresos').textContent = '$' + totalIngresos.toLocaleString();
            document.getElementById('kpi-gastos').textContent = '$' + totalGastos.toLocaleString();
            document.getElementById('kpi-rentabilidad').textContent = '$' + (totalIngresos - totalGastos).toLocaleString();
            document.getElementById('kpi-noches').textContent = totalNoches;
            document.getElementById('kpi-ocupacion').textContent = ((totalNoches / (365 * propiedades.length)) * 100).toFixed(1) + '% ocupaci√≥n';
            
            const ctx1 = document.getElementById('chart-ingresos').getContext('2d');
            if (window.chartIngresos) window.chartIngresos.destroy();
            window.chartIngresos = new Chart(ctx1, {
                type: 'bar',
                data: { labels: Object.keys(ingresosPorPropiedad), datasets: [{ data: Object.values(ingresosPorPropiedad), backgroundColor: ['#3498db','#e74c3c','#2ecc71','#9b59b6','#f39c12','#1abc9c','#e67e22','#34495e'] }] },
                options: { plugins: { legend: { display: false } } }
            });
            
            const ctx2 = document.getElementById('chart-origen').getContext('2d');
            if (window.chartOrigen) window.chartOrigen.destroy();
            window.chartOrigen = new Chart(ctx2, {
                type: 'doughnut',
                data: { labels: Object.keys(ingresosPorOrigen), datasets: [{ data: Object.values(ingresosPorOrigen), backgroundColor: ['#2ecc71','#9b59b6','#f1c40f'] }] }
            });
        }
        
        async function loadReportes() {
            // Cargar ingresos detalle
            const resIng = await fetch(`/api/ingresos-detalle/${currentYear}`);
            ingresosData = await resIng.json();
            filtrarIngresos();
            
            // Cargar gastos detalle
            const resGast = await fetch(`/api/gastos-detalle/${currentYear}`);
            gastosData = await resGast.json();
            filtrarGastosReporte();
            
            // Cargar resumen
            const resSum = await fetch(`/api/resumen/${currentYear}`);
            const data = await resSum.json();
            
            const porProp = {};
            data.ingresos.forEach(i => {
                if (!porProp[i.nombre]) porProp[i.nombre] = { ing: 0, noches: 0, due√±o: 0, terceros: 0 };
                porProp[i.nombre].ing += i.total_ingresos;
                porProp[i.nombre].noches += i.noches;
                if (i.origen === 'Due√±o') porProp[i.nombre].due√±o += i.total_ingresos;
                else porProp[i.nombre].terceros += i.total_ingresos;
            });
            
            const gastosPorProp = {};
            data.gastos.forEach(g => {
                if (g.nombre) gastosPorProp[g.nombre] = (gastosPorProp[g.nombre] || 0) + g.total_gastos;
            });
            
            let html = '', totIng = 0, totGast = 0, totNoches = 0, totDue√±o = 0, totTerc = 0;
            const rentPorProp = {};
            
            for (const [nombre, d] of Object.entries(porProp)) {
                const gast = gastosPorProp[nombre] || 0;
                const rent = d.ing - gast;
                const ticket = d.noches > 0 ? d.ing / d.noches : 0;
                const ocup = (d.noches / 365 * 100);
                
                rentPorProp[nombre] = rent;
                totIng += d.ing; totGast += gast; totNoches += d.noches;
                totDue√±o += d.due√±o; totTerc += d.terceros;
                
                html += `<tr>
                    <td>${nombre}</td>
                    <td>$${d.ing.toLocaleString()}</td>
                    <td>$${gast.toLocaleString()}</td>
                    <td style="color:${rent >= 0 ? '#2ecc71' : '#e74c3c'}">$${rent.toLocaleString()}</td>
                    <td>${d.noches}</td>
                    <td>${ocup.toFixed(1)}%</td>
                    <td>$${ticket.toFixed(0)}</td>
                    <td>$${d.due√±o.toLocaleString()}</td>
                    <td>$${d.terceros.toLocaleString()}</td>
                </tr>`;
            }
            
            html += `<tr class="total-row">
                <td>TOTAL</td>
                <td>$${totIng.toLocaleString()}</td>
                <td>$${(totGast + data.gastos_generales).toLocaleString()}</td>
                <td style="color:#2ecc71">$${(totIng - totGast - data.gastos_generales).toLocaleString()}</td>
                <td>${totNoches}</td>
                <td>${(totNoches / (365 * Object.keys(porProp).length) * 100).toFixed(1)}%</td>
                <td>$${totNoches > 0 ? (totIng / totNoches).toFixed(0) : 0}</td>
                <td>$${totDue√±o.toLocaleString()}</td>
                <td>$${totTerc.toLocaleString()}</td>
            </tr>`;
            
            document.getElementById('resumen-table').innerHTML = html;
            
            // Gr√°ficos resumen
            const ctx3 = document.getElementById('chart-rent').getContext('2d');
            if (window.chartRent) window.chartRent.destroy();
            window.chartRent = new Chart(ctx3, {
                type: 'bar',
                data: { labels: Object.keys(rentPorProp), datasets: [{ data: Object.values(rentPorProp), backgroundColor: Object.values(rentPorProp).map(v => v >= 0 ? '#2ecc71' : '#e74c3c') }] },
                options: { plugins: { legend: { display: false } } }
            });
            
            const ctx4 = document.getElementById('chart-dist').getContext('2d');
            if (window.chartDist) window.chartDist.destroy();
            window.chartDist = new Chart(ctx4, {
                type: 'doughnut',
                data: { labels: Object.keys(porProp), datasets: [{ data: Object.values(porProp).map(p => p.ing), backgroundColor: ['#3498db','#e74c3c','#2ecc71','#9b59b6','#f39c12','#1abc9c','#e67e22','#34495e'] }] }
            });
        }
        
        function filtrarIngresos() {
            const prop = document.getElementById('filter-prop').value;
            const origen = document.getElementById('filter-origen').value;
            const mes = document.getElementById('filter-mes').value;
            
            let filtered = ingresosData.filter(i => {
                if (prop && i.propiedad !== prop) return false;
                if (origen && i.origen !== origen) return false;
                if (mes && i.mes !== mes) return false;
                return true;
            });
            
            const total = filtered.reduce((a, b) => a + b.precio, 0);
            const noches = filtered.length;
            
            document.getElementById('sum-ingresos').textContent = '$' + total.toLocaleString();
            document.getElementById('sum-noches').textContent = noches;
            document.getElementById('sum-ticket').textContent = noches > 0 ? '$' + (total / noches).toFixed(0) : '$0';
            
            document.getElementById('ingresos-table').innerHTML = filtered.map(i => `
                <tr>
                    <td>${i.fecha}</td>
                    <td>${i.propiedad}</td>
                    <td>$${i.precio.toLocaleString()}</td>
                    <td><span class="badge badge-${i.origen.toLowerCase()}">${i.origen}</span></td>
                    <td>${i.notas || '-'}</td>
                </tr>
            `).join('');
        }
        
        function filtrarGastosReporte() {
            const prop = document.getElementById('filter-gasto-prop').value;
            const cat = document.getElementById('filter-gasto-cat').value;
            
            let filtered = gastosData.filter(g => {
                if (prop && g.propiedad !== prop) return false;
                if (cat && g.categoria !== cat) return false;
                return true;
            });
            
            const total = filtered.reduce((a, b) => a + b.monto, 0);
            document.getElementById('sum-gastos').textContent = '$' + total.toLocaleString();
            
            document.getElementById('gastos-reporte-table').innerHTML = filtered.map(g => `
                <tr>
                    <td>${g.fecha}</td>
                    <td>${g.propiedad}</td>
                    <td>${g.categoria}</td>
                    <td>$${g.monto.toLocaleString()}</td>
                    <td>${g.descripcion || '-'}</td>
                </tr>
            `).join('');
        }
        
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
        
        function exportarExcel() {
            window.location.href = `/api/exportar/excel/${currentYear}`;
            showToast('Descargando Excel...');
        }
        
        function abrirPresentacion() {
            window.open(`/api/presentacion/${currentYear}`, '_blank');
        }
        
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.target.classList.add('active');
            if (section === 'gastos') loadGastos();
            if (section === 'reportes') loadReportes();
        }
        
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast show' + (type === 'error' ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('show'); });
        });
    </script>
</body>
</html>
