<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè† Alquileres Miami</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 240px;
            height: 100vh;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        .logo { font-size: 1.5rem; font-weight: 700; color: #4ecdc4; margin-bottom: 40px; }
        .nav-item {
            padding: 12px 16px;
            margin: 5px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .nav-item:hover, .nav-item.active { background: rgba(78, 205, 196, 0.2); color: #4ecdc4; }
        
        .main { margin-left: 240px; padding: 30px; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header h1 { font-size: 1.8rem; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        
        select, input[type="date"] {
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 0.9rem;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .kpi-card .label { color: #8892b0; font-size: 0.85rem; margin-bottom: 8px; }
        .kpi-card .value { font-size: 2rem; font-weight: 700; color: #4ecdc4; }
        .kpi-card .sub { color: #8892b0; font-size: 0.8rem; margin-top: 5px; }
        
        .section { display: none; }
        .section.active { display: block; }
        
        /* Calendar styles */
        .calendar-container { display: grid; grid-template-columns: 200px 1fr; gap: 20px; }
        .property-list { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 15px; }
        .property-item {
            padding: 12px; margin: 5px 0; border-radius: 8px;
            cursor: pointer; border-left: 4px solid transparent;
        }
        .property-item:hover { background: rgba(255,255,255,0.1); }
        .property-item.selected { background: rgba(78,205,196,0.2); border-left-color: #4ecdc4; }
        
        .calendar { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-nav-btn {
            padding: 10px 20px; border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, rgba(78,205,196,0.2), rgba(78,205,196,0.1));
            color: #4ecdc4; cursor: pointer;
            font-weight: 500; font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex; align-items: center; gap: 8px;
        }
        .calendar-nav-btn:hover { 
            background: linear-gradient(135deg, rgba(78,205,196,0.4), rgba(78,205,196,0.2));
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(78,205,196,0.3);
        }
        .calendar-nav-btn:active { transform: translateY(0); }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day-header { text-align: center; padding: 10px; color: #8892b0; font-size: 0.85rem; }
        .calendar-day {
            aspect-ratio: 1; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; border: 2px solid transparent;
            background: rgba(0,0,0,0.2); transition: all 0.2s; user-select: none;
        }
        .calendar-day:hover { border-color: rgba(78,205,196,0.5); }
        .calendar-day.empty { background: transparent; cursor: default; }
        .calendar-day.empty:hover { border-color: transparent; }
        .calendar-day .day-num { font-weight: 600; font-size: 1rem; }
        .calendar-day .day-inquilino { font-size: 0.55rem; font-weight: 500; margin-top: 2px; color: #fff; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .calendar-day .day-price { font-size: 0.6rem; color: #4ecdc4; margin-top: 1px; }
        .calendar-day .day-origen { font-size: 0.6rem; font-weight: 500; margin-top: 1px; text-transform: uppercase; letter-spacing: 0.5px; }
        .calendar-day.selected-multi { border-color: #fff !important; background: rgba(255,255,255,0.2) !important; }
        .calendar-day.ocupado-due√±o { background: rgba(46,204,113,0.3); border-color: #2ecc71; }
        .calendar-day.ocupado-due√±o .day-origen { color: #2ecc71; }
        .calendar-day.ocupado-alicia { background: rgba(155,89,182,0.3); border-color: #9b59b6; }
        .calendar-day.ocupado-alicia .day-origen { color: #9b59b6; }
        .calendar-day.ocupado-estanislao { background: rgba(241,196,15,0.3); border-color: #f1c40f; }
        .calendar-day.ocupado-estanislao .day-origen { color: #f1c40f; }
        
        .legend { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .legend-color { width: 20px; height: 20px; border-radius: 5px; }
        
        .selection-bar {
            background: rgba(78,205,196,0.2); border: 1px solid #4ecdc4;
            border-radius: 10px; padding: 15px 20px; margin-top: 20px;
            display: none; align-items: center; justify-content: space-between;
        }
        .selection-bar.show { display: flex; }
        .selection-bar .count { font-weight: 600; color: #4ecdc4; }
        .selection-bar .actions { display: flex; gap: 10px; }
        
        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
        .tab {
            padding: 12px 24px; border-radius: 10px 10px 0 0;
            background: rgba(255,255,255,0.05); cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1); border-bottom: none;
        }
        .tab:hover { background: rgba(255,255,255,0.1); }
        .tab.active { background: rgba(78,205,196,0.2); color: #4ecdc4; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Filters */
        .filters {
            display: flex; gap: 15px; margin-bottom: 20px;
            padding: 15px; background: rgba(255,255,255,0.03);
            border-radius: 10px; flex-wrap: wrap; align-items: center;
        }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { color: #8892b0; font-size: 0.85rem; }
        
        /* Tables */
        .table-container {
            background: rgba(255,255,255,0.05);
            border-radius: 16px; padding: 20px; overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; }
        th {
            text-align: left; padding: 12px 15px;
            background: rgba(78,205,196,0.1); color: #4ecdc4; font-weight: 500;
        }
        td { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        tr:hover { background: rgba(255,255,255,0.03); }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; }
        .badge-due√±o { background: rgba(46,204,113,0.2); color: #2ecc71; }
        .badge-alicia { background: rgba(155,89,182,0.2); color: #9b59b6; }
        .badge-estanislao { background: rgba(241,196,15,0.2); color: #f1c40f; }
        
        .total-row { background: rgba(78,205,196,0.1) !important; font-weight: 600; }
        
        /* Charts */
        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px; }
        .chart-card { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; }
        .chart-card h3 { margin-bottom: 15px; font-size: 1rem; color: #8892b0; }
        
        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.7);
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content { background: #1e3a5f; border-radius: 20px; padding: 30px; width: 450px; max-width: 90%; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 1.3rem; }
        .modal-close { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #8892b0; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3); color: white; font-size: 1rem;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #4ecdc4; }
        
        .btn {
            padding: 12px 24px; border-radius: 10px; border: none;
            cursor: pointer; font-size: 1rem; font-weight: 500;
        }
        .btn-primary { background: #4ecdc4; color: #0d1b2a; }
        .btn-primary:hover { background: #3dbdb5; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-success { background: #2ecc71; color: white; }
        
        .origen-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .origen-btn {
            padding: 20px 15px; border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.2);
            background: transparent; color: white; cursor: pointer; text-align: center;
        }
        .origen-btn:hover { border-color: rgba(255,255,255,0.4); }
        .origen-btn.selected { border-width: 3px; }
        .origen-btn.due√±o.selected { border-color: #2ecc71; background: rgba(46,204,113,0.2); }
        .origen-btn.alicia.selected { border-color: #9b59b6; background: rgba(155,89,182,0.2); }
        .origen-btn.estanislao.selected { border-color: #f1c40f; background: rgba(241,196,15,0.2); }
        
        .help-text {
            background: rgba(78,205,196,0.1); border: 1px solid rgba(78,205,196,0.3);
            border-radius: 10px; padding: 15px; margin-bottom: 20px; font-size: 0.9rem;
        }
        
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            padding: 15px 25px; border-radius: 10px;
            background: #2ecc71; color: white; display: none; z-index: 2000;
        }
        .toast.show { display: block; animation: slideIn 0.3s; }
        .toast.error { background: #e74c3c; }
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .summary-card {
            background: rgba(255,255,255,0.05); border-radius: 16px;
            padding: 20px; margin-bottom: 20px;
        }
        .summary-card h3 { color: #4ecdc4; margin-bottom: 15px; font-size: 1.1rem; }
        .summary-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .summary-row:last-child { border-bottom: none; }
        .summary-label { color: #8892b0; }
        .summary-value { font-weight: 600; }
        .summary-value.positive { color: #2ecc71; }
        .summary-value.negative { color: #e74c3c; }
        
        /* Tabla Calendario General */
        #tabla-general th, #tabla-general td {
            padding: 6px 3px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
            vertical-align: middle;
        }
        #tabla-general th {
            background: rgba(78,205,196,0.15);
            color: #4ecdc4;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        #tabla-general th.dia-header {
            min-width: 70px;
            font-size: 0.8rem;
        }
        #tabla-general td.prop-name {
            text-align: left;
            padding: 12px 15px;
            font-weight: 700;
            background: rgba(0,0,0,0.3);
            white-space: nowrap;
            position: sticky;
            left: 0;
            z-index: 10;
            color: #4ecdc4;
            font-size: 0.9rem;
        }
        #tabla-general td.dia-cell {
            cursor: pointer;
            transition: all 0.2s;
            height: 60px;
            font-size: 0.7rem;
            line-height: 1.2;
        }
        #tabla-general td[colspan] {
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        #tabla-general td.dia-cell:hover {
            box-shadow: inset 0 0 0 2px #fff;
        }
        #tabla-general td.libre { 
            background: rgba(0,0,0,0.3);
            border: 2px dashed rgba(46,204,113,0.4) !important;
            color: rgba(46,204,113,0.6);
            cursor: pointer;
        }
        #tabla-general td.libre:hover {
            background: rgba(46,204,113,0.15);
            border-color: rgba(46,204,113,0.8) !important;
        }
        #tabla-general td.libre.selected {
            background: rgba(46,204,113,0.3);
            border-color: #2ecc71 !important;
            box-shadow: inset 0 0 0 2px #2ecc71;
        }
        #tabla-general td.selected:not(.libre) {
            box-shadow: inset 0 0 0 3px #e74c3c !important;
            opacity: 0.8;
        }
        #tabla-general td.ocupado-due√±o { 
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: #fff;
            font-weight: 600;
        }
        #tabla-general td.ocupado-alicia { 
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: #fff;
            font-weight: 600;
        }
        #tabla-general td.ocupado-estanislao { 
            background: linear-gradient(135deg, #f39c12, #f1c40f);
            color: #000;
            font-weight: 600;
        }
        #tabla-general td.ocupado { 
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            color: #fff;
            font-weight: 600;
        }
        .celda-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        .celda-origen { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; }
        .celda-inquilino { font-size: 0.6rem; opacity: 0.9; max-width: 65px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .celda-libre { font-size: 0.7rem; opacity: 0.7; }
        
        .celda-info-merged {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 4px;
        }
        .merged-inquilino {
            font-size: 0.85rem;
            font-weight: 700;
            text-align: center;
            line-height: 1.2;
        }
        .merged-detalle {
            font-size: 0.65rem;
            opacity: 0.8;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">üè† Miami</div>
        <div class="nav-item active" onclick="showSection('dashboard')">üìä Dashboard</div>
        <div class="nav-item" onclick="showSection('calendario-general')">üóìÔ∏è Vista General</div>
        <div class="nav-item" onclick="showSection('ocupacion')">üìÖ Ocupaci√≥n</div>
        <div class="nav-item" onclick="showSection('gastos')">üí∞ Gastos</div>
        <div class="nav-item" onclick="showSection('reportes')">üìà Reportes</div>
    </div>
    
    <div class="main">
        <!-- Dashboard -->
        <div id="dashboard" class="section active">
            <div class="header">
                <h1>Dashboard</h1>
                <div class="header-actions">
                    <select id="yearSelect" onchange="loadAll()">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                    <button class="btn btn-success" onclick="abrirPresentacion()">üéØ Ver Presentaci√≥n</button>
                </div>
            </div>
            
            <!-- Filtros del Dashboard -->
            <div class="filters" style="margin-bottom:20px">
                <div class="filter-group">
                    <label>üìÖ Mes:</label>
                    <select id="dash-filter-mes" onchange="applyDashboardFilters()">
                        <option value="">Todos</option>
                        <option value="01">Enero</option>
                        <option value="02">Febrero</option>
                        <option value="03">Marzo</option>
                        <option value="04">Abril</option>
                        <option value="05">Mayo</option>
                        <option value="06">Junio</option>
                        <option value="07">Julio</option>
                        <option value="08">Agosto</option>
                        <option value="09">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üè† Propiedad:</label>
                    <select id="dash-filter-prop" onchange="applyDashboardFilters()">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>üë§ Origen:</label>
                    <select id="dash-filter-origen" onchange="applyDashboardFilters()">
                        <option value="">Todos</option>
                        <option value="Alquiler propio">Alquiler propio</option>
                        <option value="Alicia">Alicia</option>
                        <option value="Estanislao">Estanislao</option>
                    </select>
                </div>
                <button class="btn btn-secondary" onclick="clearDashboardFilters()" style="margin-left:auto">üîÑ Limpiar filtros</button>
            </div>
            
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="label">Ingresos Totales</div>
                    <div class="value" id="kpi-ingresos">$0</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Gastos Totales</div>
                    <div class="value" id="kpi-gastos" style="color:#e74c3c">$0</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Rentabilidad</div>
                    <div class="value" id="kpi-rentabilidad">$0</div>
                </div>
                <div class="kpi-card">
                    <div class="label">Noches Ocupadas</div>
                    <div class="value" id="kpi-noches">0</div>
                    <div class="sub" id="kpi-ocupacion">0% ocupaci√≥n</div>
                </div>
            </div>
            
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>üìä Ingresos por Propiedad</h3>
                    <canvas id="chart-ingresos"></canvas>
                </div>
                <div class="chart-card">
                    <h3>üë• Ingresos por Origen</h3>
                    <canvas id="chart-origen"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Calendario General -->
        <div id="calendario-general" class="section">
            <div class="header">
                <h1>üóìÔ∏è Vista General - Cargar Departamentos</h1>
            </div>
            
            <div class="calendar" style="overflow-x: auto;">
                <div class="help-text" style="margin-bottom:15px">
                    üí° <strong>Tip:</strong> Hac√© click en las celdas LIBRE para cargar ocupaci√≥n. Seleccion√° varias celdas y despu√©s "Cargar selecci√≥n"
                </div>
                
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="changeMonthGeneral(-1)">‚óÄ Anterior</button>
                    <h2 id="calendar-month-general">Diciembre 2025</h2>
                    <button class="calendar-nav-btn" onclick="changeMonthGeneral(1)">Siguiente ‚ñ∂</button>
                </div>
                
                <div class="legend" style="margin-bottom:20px">
                    <div class="legend-item"><div class="legend-color" style="background:#1a1a2e;border:2px dashed rgba(46,204,113,0.5)"></div><span>LIBRE (click para cargar)</span></div>
                    <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#27ae60,#2ecc71)"></div><span>Alquiler propio</span></div>
                    <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#8e44ad,#9b59b6)"></div><span>Alicia</span></div>
                    <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#f39c12,#f1c40f)"></div><span>Estanislao</span></div>
                </div>
                
                <table id="tabla-general" style="width:100%;border-collapse:collapse;font-size:0.85rem;">
                    <thead id="tabla-general-header"></thead>
                    <tbody id="tabla-general-body"></tbody>
                </table>
                
                <div class="selection-bar" id="selection-bar-general" style="display:none">
                    <span><span class="count" id="selected-count-general">0</span> celdas seleccionadas</span>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="clearSelectionGeneral()">Cancelar</button>
                        <button class="btn btn-primary" id="btn-cargar-general" onclick="openMultiModalGeneral()">Cargar selecci√≥n</button>
                        <button class="btn btn-danger" id="btn-eliminar-general" style="background:#e74c3c;display:none" onclick="eliminarSeleccionGeneral()">üóëÔ∏è Eliminar selecci√≥n</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ocupaci√≥n (solo mensuales: Brickell y Locales) -->
        <div id="ocupacion" class="section">
            <div class="header">
                <h1>üè¢ Alquileres Mensuales</h1>
                <p style="color:#8892b0;margin-top:5px">Brickell, Local 1 y Local 2</p>
            </div>
            
            <div class="calendar-container">
                <div class="property-list">
                    <h3 style="margin-bottom:15px;color:#4ecdc4">Propiedades</h3>
                    <div id="property-list-mensual"></div>
                </div>
                
                <!-- Formulario para Brickell/Locales (mensuales) -->
                <div class="calendar" id="calendar-mensual">
                    <div class="help-text" style="margin-bottom:20px">
                        üè¢ <strong>Alquiler Mensual:</strong> Carg√° el monto cobrado por cada mes
                    </div>
                    
                    <h3 id="mensual-propiedad-nombre" style="color:#4ecdc4;margin-bottom:20px">Propiedad</h3>
                    
                    <div class="mensual-year-selector" style="display:flex;gap:10px;margin-bottom:20px;align-items:center">
                        <label style="color:#8892b0">A√±o:</label>
                        <select id="mensual-year" onchange="loadAlquileresMensuales()" style="padding:10px;border-radius:8px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);color:white">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                        </select>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr><th>Mes</th><th>Monto USD</th><th>Notas</th><th></th></tr>
                            </thead>
                            <tbody id="mensual-table"></tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top:20px">
                        <button class="btn btn-primary" onclick="openMensualModal()">+ Agregar Mes</button>
                    </div>
                    
                    <div class="summary-card" style="margin-top:20px">
                        <h3>üìä Resumen Anual</h3>
                        <div class="summary-row">
                            <span class="summary-label">Total Cobrado:</span>
                            <span class="summary-value positive" id="mensual-total">$0</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Meses Cargados:</span>
                            <span class="summary-value" id="mensual-meses">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Gastos -->
        <div id="gastos" class="section">
            <div class="header">
                <h1>üí∞ Gastos</h1>
                <button class="btn btn-primary" onclick="openGastoModal()">+ Nuevo Gasto</button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Fecha</th><th>Propiedad</th><th>Categor√≠a</th><th>Monto</th><th>Descripci√≥n</th><th></th></tr>
                    </thead>
                    <tbody id="gastos-table"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Reportes -->
        <div id="reportes" class="section">
            <div class="header">
                <h1>üìà Reportes</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="openImportModal()">üì§ Importar Excel</button>
                    <button class="btn btn-primary" onclick="exportarExcel()">üì• Exportar Excel</button>
                    <button class="btn btn-success" onclick="abrirPresentacion()">üéØ Presentaci√≥n</button>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('tab-ingresos')">üíµ Ingresos</div>
                <div class="tab" onclick="showTab('tab-gastos')">üí∏ Gastos</div>
                <div class="tab" onclick="showTab('tab-resumen')">üìä Resumen</div>
            </div>
            
            <!-- Tab Ingresos -->
            <div id="tab-ingresos" class="tab-content active">
                <div class="filters">
                    <div class="filter-group">
                        <label>Propiedad:</label>
                        <select id="filter-prop" onchange="filtrarIngresos()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Origen:</label>
                        <select id="filter-origen" onchange="filtrarIngresos()">
                            <option value="">Todos</option>
                            <option value="Alquiler propio">Alquiler propio</option>
                            <option value="Alicia">Alicia</option>
                            <option value="Estanislao">Estanislao</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Mes:</label>
                        <select id="filter-mes" onchange="filtrarIngresos()">
                            <option value="">Todos</option>
                            <option value="01">Enero</option>
                            <option value="02">Febrero</option>
                            <option value="03">Marzo</option>
                            <option value="04">Abril</option>
                            <option value="05">Mayo</option>
                            <option value="06">Junio</option>
                            <option value="07">Julio</option>
                            <option value="08">Agosto</option>
                            <option value="09">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                    </div>
                </div>
                
                <div class="summary-card">
                    <h3>üìä Resumen Filtrado</h3>
                    <div class="summary-row">
                        <span class="summary-label">Total Ingresos:</span>
                        <span class="summary-value positive" id="sum-ingresos">$0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Noches:</span>
                        <span class="summary-value" id="sum-noches">0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Ticket Promedio:</span>
                        <span class="summary-value" id="sum-ticket">$0</span>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Fecha</th><th>Propiedad</th><th>Precio</th><th>Origen</th><th>Notas</th></tr>
                        </thead>
                        <tbody id="ingresos-table"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab Gastos -->
            <div id="tab-gastos" class="tab-content">
                <div class="filters">
                    <div class="filter-group">
                        <label>Propiedad:</label>
                        <select id="filter-gasto-prop" onchange="filtrarGastosReporte()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Categor√≠a:</label>
                        <select id="filter-gasto-cat" onchange="filtrarGastosReporte()">
                            <option value="">Todas</option>
                            <option value="Expensas">Expensas</option>
                            <option value="Impuestos">Impuestos</option>
                            <option value="Reparaciones">Reparaciones</option>
                            <option value="Comisiones">Comisiones</option>
                            <option value="Limpieza">Limpieza</option>
                            <option value="Servicios">Servicios</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                </div>
                
                <div class="summary-card">
                    <h3>üí∏ Resumen Filtrado</h3>
                    <div class="summary-row">
                        <span class="summary-label">Total Gastos:</span>
                        <span class="summary-value negative" id="sum-gastos">$0</span>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Fecha</th><th>Propiedad</th><th>Categor√≠a</th><th>Monto</th><th>Descripci√≥n</th></tr>
                        </thead>
                        <tbody id="gastos-reporte-table"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Tab Resumen -->
            <div id="tab-resumen" class="tab-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Propiedad</th><th>Ingresos</th><th>Gastos</th><th>Rentabilidad</th><th>Noches</th><th>% Ocup</th><th>Ticket</th><th>Alquiler propio</th><th>Terceros</th></tr>
                        </thead>
                        <tbody id="resumen-table"></tbody>
                    </table>
                </div>
                
                <div class="charts-grid" style="margin-top:30px">
                    <div class="chart-card">
                        <h3>üí∞ Rentabilidad por Propiedad</h3>
                        <canvas id="chart-rent"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>üìä Distribuci√≥n de Ingresos</h3>
                        <canvas id="chart-dist"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Ocupaci√≥n -->
    <div class="modal" id="ocupacion-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Cargar Ocupaci√≥n</h3>
                <button class="modal-close" onclick="closeModal('ocupacion-modal')">&times;</button>
            </div>
            <form id="ocupacion-form">
                <div class="form-group">
                    <label>¬øQui√©n lo alquil√≥?</label>
                    <div class="origen-selector">
                        <button type="button" class="origen-btn due√±o" data-origen="Alquiler propio" onclick="selectOrigen(this)">üë§<br>Alquiler propio</button>
                        <button type="button" class="origen-btn alicia" data-origen="Alicia" onclick="selectOrigen(this)">üë©<br>Alicia</button>
                        <button type="button" class="origen-btn estanislao" data-origen="Estanislao" onclick="selectOrigen(this)">üë®<br>Estanislao</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Precio por noche (USD)</label>
                    <input type="number" id="ocup-precio" placeholder="150" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label>Nombre del inquilino</label>
                    <input type="text" id="ocup-notas" placeholder="Ej: Sergio las Heras">
                </div>
                <div style="display:flex;gap:10px">
                    <button type="submit" class="btn btn-primary" style="flex:1">Guardar</button>
                    <button type="button" class="btn btn-danger" onclick="eliminarSeleccion()" id="btn-eliminar" style="display:none">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Gasto -->
    <div class="modal" id="gasto-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Gasto</h3>
                <button class="modal-close" onclick="closeModal('gasto-modal')">&times;</button>
            </div>
            <form id="gasto-form">
                <div class="form-group">
                    <label>Fecha</label>
                    <input type="date" id="gasto-fecha" required>
                </div>
                <div class="form-group">
                    <label>Propiedad (vac√≠o = general)</label>
                    <select id="gasto-propiedad"><option value="">General</option></select>
                </div>
                <div class="form-group">
                    <label>Categor√≠a</label>
                    <select id="gasto-categoria" required>
                        <option value="Expensas">Expensas</option>
                        <option value="Impuestos">Impuestos</option>
                        <option value="Reparaciones">Reparaciones</option>
                        <option value="Comisiones">Comisiones</option>
                        <option value="Limpieza">Limpieza</option>
                        <option value="Servicios">Servicios</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Monto (USD)</label>
                    <input type="number" id="gasto-monto" placeholder="100" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <input type="text" id="gasto-descripcion" placeholder="Ej: Expensas enero">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Guardar</button>
            </form>
        </div>
    </div>
    
    <!-- Modal Alquiler Mensual -->
    <div class="modal" id="mensual-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Cargar Alquiler Mensual</h3>
                <button class="modal-close" onclick="closeModal('mensual-modal')">&times;</button>
            </div>
            <form id="mensual-form">
                <div class="form-group">
                    <label>Mes</label>
                    <select id="mensual-mes" required>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Monto (USD)</label>
                    <input type="number" id="mensual-monto" placeholder="2000" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Notas (opcional)</label>
                    <input type="text" id="mensual-notas" placeholder="Ej: Pagado en efectivo">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Guardar</button>
            </form>
        </div>
    </div>
    
    <!-- Modal Exportar Excel -->
    <div class="modal" id="excel-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì• Exportar a Excel</h3>
                <button class="modal-close" onclick="closeModal('excel-modal')">&times;</button>
            </div>
            <div class="help-text" style="margin-bottom:20px">
                Seleccion√° el rango de fechas que quer√©s exportar
            </div>
            <form id="excel-form">
                <div class="form-group">
                    <label>Fecha Desde</label>
                    <input type="date" id="excel-desde" required>
                </div>
                <div class="form-group">
                    <label>Fecha Hasta</label>
                    <input type="date" id="excel-hasta" required>
                </div>
                <div class="form-group">
                    <label>Propiedad (opcional)</label>
                    <select id="excel-propiedad">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div style="display:flex;gap:10px">
                    <button type="button" class="btn btn-secondary" style="flex:1" onclick="setExcelRangeYear()">üìÖ A√±o completo</button>
                    <button type="submit" class="btn btn-primary" style="flex:1">üì• Descargar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Importar Excel -->
    <div class="modal" id="import-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì§ Importar Alquileres desde Excel</h3>
                <button class="modal-close" onclick="closeModal('import-modal')">&times;</button>
            </div>
            
            <div class="help-text" style="margin-bottom:20px">
                Sub√≠ el Excel completado por Alicia o Estanislao
            </div>
            
            <div style="margin-bottom:20px">
                <a href="/api/descargar-template" class="btn btn-secondary" style="display:inline-block;text-decoration:none">
                    üìÑ Descargar Template vac√≠o
                </a>
            </div>
            
            <form id="import-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label>¬øQui√©n carg√≥ estos alquileres?</label>
                    <div class="origen-selector">
                        <button type="button" class="origen-btn alicia" data-origen="Alicia" onclick="selectImportOrigen(this)">üë©<br>Alicia</button>
                        <button type="button" class="origen-btn estanislao" data-origen="Estanislao" onclick="selectImportOrigen(this)">üë®<br>Estanislao</button>
                        <button type="button" class="origen-btn due√±o" data-origen="Alquiler propio" onclick="selectImportOrigen(this)">üë§<br>Alquiler propio</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Archivo Excel</label>
                    <input type="file" id="import-file" accept=".xlsx,.xls" required 
                           style="padding:15px;border:2px dashed rgba(255,255,255,0.3);border-radius:10px;width:100%;background:rgba(0,0,0,0.2)">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">üì§ Importar</button>
            </form>
            
            <div id="import-result" style="margin-top:20px;display:none">
                <div class="summary-card">
                    <h3 id="import-result-title">Resultado</h3>
                    <div id="import-result-content"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Editar/Eliminar Ocupaci√≥n -->
    <div class="modal" id="edit-ocup-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Ocupaci√≥n</h3>
                <button class="modal-close" onclick="closeModal('edit-ocup-modal')">&times;</button>
            </div>
            
            <div class="help-text" style="margin-bottom:15px" id="edit-ocup-info">
                Informaci√≥n de la ocupaci√≥n
            </div>
            
            <form id="edit-ocup-form" onsubmit="event.preventDefault(); submitEditOcup();">
                <input type="hidden" id="edit-ocup-id">
                <input type="hidden" id="edit-ocup-propid">
                <input type="hidden" id="edit-ocup-fecha">
                
                <div class="form-group">
                    <label>¬øQui√©n lo alquil√≥?</label>
                    <div class="origen-selector">
                        <button type="button" class="origen-btn due√±o" data-origen="Alquiler propio" onclick="selectEditOrigen(this)">üë§<br>Alquiler propio</button>
                        <button type="button" class="origen-btn alicia" data-origen="Alicia" onclick="selectEditOrigen(this)">üë©<br>Alicia</button>
                        <button type="button" class="origen-btn estanislao" data-origen="Estanislao" onclick="selectEditOrigen(this)">üë®<br>Estanislao</button>
                    </div>
                    <input type="hidden" id="edit-ocup-origen">
                </div>
                <div class="form-group">
                    <label>Precio por noche (USD)</label>
                    <input type="number" id="edit-ocup-precio" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Nombre del inquilino</label>
                    <input type="text" id="edit-ocup-notas" placeholder="Ej: Sergio las Heras">
                </div>
                <div style="display:flex;gap:10px">
                    <button type="submit" class="btn btn-primary" style="flex:1">‚úÖ Guardar</button>
                    <button type="button" class="btn btn-danger" style="flex:1;background:#e74c3c" onclick="deleteOcup()">üóëÔ∏è Eliminar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Cargar desde Vista General -->
    <div class="modal" id="multi-general-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìÖ Cargar Ocupaci√≥n</h3>
                <button class="modal-close" onclick="closeModal('multi-general-modal')">&times;</button>
            </div>
            
            <div class="help-text" style="margin-bottom:15px" id="multi-resumen">
                Resumen de la selecci√≥n
            </div>
            
            <form id="multi-general-form" onsubmit="event.preventDefault(); submitMultiGeneral();">
                <input type="hidden" id="multi-origen" value="Alquiler propio">
                <div class="form-group">
                    <label>Precio por noche (USD)</label>
                    <input type="number" id="multi-precio" min="0" step="0.01" required placeholder="Ej: 150">
                </div>
                <div class="form-group">
                    <label>Nombre del inquilino</label>
                    <input type="text" id="multi-notas" placeholder="Ej: Sergio las Heras">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">‚úÖ Guardar</button>
            </form>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        let propiedades = [];
        let selectedProperty = null;
        let selectedPropertyType = 'temporario';
        let currentYear = 2025;
        let currentMonth = 12;
        let ocupaciones = {};
        let selectedOrigen = null;
        let selectedDays = new Set();
        let ingresosData = [];
        let gastosData = [];
        let alquileresMensualesData = [];
        let dashboardRawData = null;
        const MESES = ['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        
        document.addEventListener('DOMContentLoaded', () => {
            loadPropiedades();
            loadAll();
            document.getElementById('gasto-fecha').valueAsDate = new Date();
        });
        
        function loadAll() {
            currentYear = parseInt(document.getElementById('yearSelect').value);
            loadDashboard();
            loadGastos();
            loadReportes();
        }
        
        async function loadPropiedades() {
            const res = await fetch('/api/propiedades');
            propiedades = await res.json();
            
            // Solo mensuales en la secci√≥n de Ocupaci√≥n
            const mensuales = propiedades.filter(p => p.tipo === 'mensual');
            document.getElementById('property-list-mensual').innerHTML = mensuales.map(p => `
                <div class="property-item" data-id="${p.id}" onclick="selectPropertyMensual(${p.id})">
                    üè¢ ${p.nombre}
                </div>
            `).join('');
            
            ['gasto-propiedad', 'filter-prop', 'filter-gasto-prop'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const firstOpt = el.querySelector('option');
                    el.innerHTML = firstOpt ? firstOpt.outerHTML : '';
                    propiedades.forEach(p => {
                        el.innerHTML += `<option value="${p.nombre}">${p.nombre}</option>`;
                    });
                }
            });
            
            // Seleccionar la primera propiedad mensual
            if (mensuales.length > 0) selectPropertyMensual(mensuales[0].id);
        }
        
        function selectPropertyMensual(id) {
            selectedProperty = id;
            const prop = propiedades.find(p => p.id === id);
            selectedPropertyType = 'mensual';
            
            document.querySelectorAll('#property-list-mensual .property-item').forEach(el => {
                el.classList.toggle('selected', el.dataset.id == id);
            });
            
            // Siempre mostrar formulario mensual
            document.getElementById('calendar-mensual').style.display = 'block';
            document.getElementById('mensual-propiedad-nombre').textContent = 'üè¢ ' + prop.nombre;
            loadAlquileresMensuales();
        }
        
        async function loadCalendar() {
            if (!selectedProperty) return;
            const res = await fetch(`/api/ocupaciones/${currentYear}/${currentMonth}`);
            const data = await res.json();
            ocupaciones = {};
            data.forEach(o => { ocupaciones[`${o.propiedad_id}-${o.fecha}`] = o; });
            renderCalendar();
        }
        
        function renderCalendar() {
            const monthNames = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            document.getElementById('calendar-month').textContent = `${monthNames[currentMonth-1]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const lastDay = new Date(currentYear, currentMonth, 0);
            const startWeekDay = firstDay.getDay();
            const totalDays = lastDay.getDate();
            
            let html = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'].map(d => `<div class="calendar-day-header">${d}</div>`).join('');
            for (let i = 0; i < startWeekDay; i++) html += '<div class="calendar-day empty"></div>';
            
            for (let day = 1; day <= totalDays; day++) {
                const fecha = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const key = `${selectedProperty}-${fecha}`;
                const ocup = ocupaciones[key];
                
                let classes = 'calendar-day';
                let content = `<span class="day-num">${day}</span>`;
                
                if (ocup) {
                    classes += ` ocupado-${ocup.origen.toLowerCase()}`;
                    // Mostrar nombre del inquilino (de las notas)
                    if (ocup.notas) {
                        content += `<span class="day-inquilino">${ocup.notas}</span>`;
                    }
                    if (ocup.precio > 0) content += `<span class="day-price">$${ocup.precio}</span>`;
                }
                if (selectedDays.has(fecha)) classes += ' selected-multi';
                
                html += `<div class="${classes}" data-fecha="${fecha}" onclick="toggleDay('${fecha}')">${content}</div>`;
            }
            document.getElementById('calendar-grid').innerHTML = html;
        }
        
        function toggleDay(fecha) {
            selectedDays.has(fecha) ? selectedDays.delete(fecha) : selectedDays.add(fecha);
            updateSelectionBar();
            renderCalendar();
        }
        
        function updateSelectionBar() {
            const bar = document.getElementById('selection-bar');
            document.getElementById('selected-count').textContent = selectedDays.size;
            bar.classList.toggle('show', selectedDays.size > 0);
        }
        
        function clearSelection() {
            selectedDays.clear();
            updateSelectionBar();
            renderCalendar();
        }
        
        function openMultiModal() {
            if (selectedDays.size === 0) return;
            const prop = propiedades.find(p => p.id === selectedProperty);
            const fechas = Array.from(selectedDays).sort();
            
            document.getElementById('modal-title').textContent = fechas.length === 1 ? `${prop.nombre} - ${fechas[0]}` : `${prop.nombre} - ${fechas.length} d√≠as`;
            
            const key = `${selectedProperty}-${fechas[0]}`;
            const ocup = ocupaciones[key];
            
            if (ocup && fechas.length === 1) {
                document.getElementById('ocup-precio').value = ocup.precio;
                document.getElementById('ocup-notas').value = ocup.notas || '';
                document.getElementById('btn-eliminar').style.display = 'block';
                document.querySelectorAll('.origen-btn').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.origen === ocup.origen);
                    if (btn.dataset.origen === ocup.origen) selectedOrigen = ocup.origen;
                });
            } else {
                document.getElementById('ocup-precio').value = '';
                document.getElementById('ocup-notas').value = '';
                document.getElementById('btn-eliminar').style.display = 'none';
                document.querySelectorAll('.origen-btn').forEach(btn => btn.classList.remove('selected'));
                selectedOrigen = null;
            }
            document.getElementById('ocupacion-modal').classList.add('show');
        }
        
        function selectOrigen(btn) {
            document.querySelectorAll('.origen-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedOrigen = btn.dataset.origen;
        }
        
        function selectMultiOrigen(btn) {
            document.querySelectorAll('#multi-general-modal .origen-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('multi-origen').value = btn.dataset.origen;
        }
        
        function selectEditOrigen(btn) {
            document.querySelectorAll('#edit-ocup-modal .origen-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById('edit-ocup-origen').value = btn.dataset.origen;
        }
        
        function openEditOcup(infoStr) {
            const info = typeof infoStr === 'string' ? JSON.parse(infoStr) : infoStr;
            
            document.getElementById('edit-ocup-id').value = info.id;
            document.getElementById('edit-ocup-propid').value = info.propId;
            document.getElementById('edit-ocup-fecha').value = info.fecha;
            document.getElementById('edit-ocup-precio').value = info.precio;
            document.getElementById('edit-ocup-notas').value = info.notas || '';
            document.getElementById('edit-ocup-origen').value = info.origen;
            
            document.getElementById('edit-ocup-info').innerHTML = `<strong>${info.prop}</strong> - ${info.fecha}`;
            
            // Marcar el bot√≥n de origen correcto
            document.querySelectorAll('#edit-ocup-modal .origen-btn').forEach(b => {
                b.classList.toggle('selected', b.dataset.origen === info.origen);
            });
            
            document.getElementById('edit-ocup-modal').classList.add('show');
        }
        
        async function submitEditOcup() {
            const id = document.getElementById('edit-ocup-id').value;
            const precio = parseFloat(document.getElementById('edit-ocup-precio').value);
            const origen = document.getElementById('edit-ocup-origen').value;
            const notas = document.getElementById('edit-ocup-notas').value;
            
            if (!precio || precio <= 0) { showToast('Ingres√° un precio v√°lido', 'error'); return; }
            if (!origen) { showToast('Seleccion√° qui√©n alquil√≥', 'error'); return; }
            
            await fetch(`/api/ocupacion/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ precio, origen, notas })
            });
            
            document.getElementById('edit-ocup-modal').classList.remove('show');
            loadCalendarioGeneral();
            loadAll();
            showToast('Ocupaci√≥n actualizada', 'success');
        }
        
        async function deleteOcup() {
            if (!confirm('¬øSeguro que quer√©s eliminar esta ocupaci√≥n?')) return;
            
            const propId = document.getElementById('edit-ocup-propid').value;
            const fecha = document.getElementById('edit-ocup-fecha').value;
            
            await fetch(`/api/ocupacion/${propId}/${fecha}`, { method: 'DELETE' });
            
            document.getElementById('edit-ocup-modal').classList.remove('show');
            loadCalendarioGeneral();
            loadAll();
            showToast('Ocupaci√≥n eliminada', 'success');
        }
        
        document.getElementById('ocupacion-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!selectedOrigen) { showToast('Seleccion√° qui√©n lo alquil√≥', 'error'); return; }
            
            const precio = parseFloat(document.getElementById('ocup-precio').value) || 0;
            const notas = document.getElementById('ocup-notas').value;
            let saved = 0;
            
            for (const fecha of selectedDays) {
                const res = await fetch('/api/ocupacion', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ propiedad_id: selectedProperty, fecha, precio, origen: selectedOrigen, notas })
                });
                if (res.ok) saved++;
            }
            
            showToast(`${saved} d√≠as guardados ‚úì`);
            closeModal('ocupacion-modal');
            clearSelection();
            loadCalendar();
            loadAll();
        });
        
        async function eliminarSeleccion() {
            if (!confirm(`¬øEliminar ${selectedDays.size} d√≠a(s)?`)) return;
            for (const fecha of selectedDays) {
                await fetch(`/api/ocupacion/${selectedProperty}/${fecha}`, {method: 'DELETE'});
            }
            showToast('Eliminado');
            closeModal('ocupacion-modal');
            clearSelection();
            loadCalendar();
            loadAll();
        }
        
        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 12) { currentMonth = 1; currentYear++; }
            if (currentMonth < 1) { currentMonth = 12; currentYear--; }
            clearSelection();
            loadCalendar();
        }
        
        async function loadGastos() {
            const res = await fetch(`/api/gastos?year=${currentYear}`);
            const gastos = await res.json();
            document.getElementById('gastos-table').innerHTML = gastos.map(g => `
                <tr>
                    <td>${g.fecha}</td>
                    <td>${g.propiedad_nombre || 'General'}</td>
                    <td>${g.categoria}</td>
                    <td>$${g.monto.toLocaleString()}</td>
                    <td>${g.descripcion || '-'}</td>
                    <td><button class="btn btn-danger" onclick="eliminarGasto(${g.id})" style="padding:5px 10px;font-size:0.8rem">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }
        
        function openGastoModal() { document.getElementById('gasto-modal').classList.add('show'); }
        
        document.getElementById('gasto-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const res = await fetch('/api/gastos', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    fecha: document.getElementById('gasto-fecha').value,
                    propiedad_id: document.getElementById('gasto-propiedad').value || null,
                    categoria: document.getElementById('gasto-categoria').value,
                    monto: parseFloat(document.getElementById('gasto-monto').value),
                    descripcion: document.getElementById('gasto-descripcion').value
                })
            });
            if (res.ok) {
                showToast('Gasto guardado ‚úì');
                closeModal('gasto-modal');
                document.getElementById('gasto-form').reset();
                document.getElementById('gasto-fecha').valueAsDate = new Date();
                loadAll();
            }
        });
        
        async function eliminarGasto(id) {
            if (confirm('¬øEliminar?')) {
                await fetch(`/api/gasto/${id}`, {method: 'DELETE'});
                showToast('Eliminado');
                loadAll();
            }
        }
        
        async function loadDashboard() {
            // Cargar datos detallados para poder filtrar
            const [resIng, resGast, resSum] = await Promise.all([
                fetch(`/api/ingresos-detalle/${currentYear}`),
                fetch(`/api/gastos-detalle/${currentYear}`),
                fetch(`/api/resumen/${currentYear}`)
            ]);
            
            dashboardRawData = {
                ingresos: await resIng.json(),
                gastos: await resGast.json(),
                resumen: await resSum.json()
            };
            
            // Llenar selector de propiedades del dashboard
            const selectProp = document.getElementById('dash-filter-prop');
            const currentVal = selectProp.value;
            selectProp.innerHTML = '<option value="">Todas</option>';
            propiedades.forEach(p => {
                selectProp.innerHTML += `<option value="${p.nombre}">${p.nombre}</option>`;
            });
            selectProp.value = currentVal;
            
            applyDashboardFilters();
        }
        
        function applyDashboardFilters() {
            if (!dashboardRawData) return;
            
            const filterMes = document.getElementById('dash-filter-mes').value;
            const filterProp = document.getElementById('dash-filter-prop').value;
            const filterOrigen = document.getElementById('dash-filter-origen').value;
            
            // Filtrar ingresos
            let ingFiltrados = dashboardRawData.ingresos.filter(i => {
                if (filterMes && i.mes !== filterMes) return false;
                if (filterProp && i.propiedad !== filterProp) return false;
                if (filterOrigen && i.origen !== filterOrigen) return false;
                return true;
            });
            
            // Filtrar gastos
            let gastFiltrados = dashboardRawData.gastos.filter(g => {
                if (filterMes && g.mes !== filterMes) return false;
                if (filterProp && g.propiedad !== filterProp && g.propiedad !== 'General') return false;
                return true;
            });
            
            // Calcular totales
            let totalIngresos = 0, totalNoches = 0, ingresosPorOrigen = {}, ingresosPorPropiedad = {};
            
            ingFiltrados.forEach(i => {
                totalIngresos += i.precio;
                totalNoches += 1;
                ingresosPorOrigen[i.origen] = (ingresosPorOrigen[i.origen] || 0) + i.precio;
                ingresosPorPropiedad[i.propiedad] = (ingresosPorPropiedad[i.propiedad] || 0) + i.precio;
            });
            
            let totalGastos = gastFiltrados.reduce((sum, g) => sum + g.monto, 0);
            
            // Calcular d√≠as del per√≠odo para ocupaci√≥n
            let diasPeriodo = 365;
            if (filterMes) {
                const mes = parseInt(filterMes);
                diasPeriodo = new Date(currentYear, mes, 0).getDate();
            }
            
            const propsTemporarias = filterProp ? 1 : (propiedades.filter(p => p.tipo === 'temporario').length || 5);
            const pctOcupacion = ((totalNoches / (diasPeriodo * propsTemporarias)) * 100);
            
            document.getElementById('kpi-ingresos').textContent = '$' + totalIngresos.toLocaleString();
            document.getElementById('kpi-gastos').textContent = '$' + totalGastos.toLocaleString();
            document.getElementById('kpi-rentabilidad').textContent = '$' + (totalIngresos - totalGastos).toLocaleString();
            document.getElementById('kpi-noches').textContent = totalNoches;
            document.getElementById('kpi-ocupacion').textContent = pctOcupacion.toFixed(1) + '% ocupaci√≥n';
            
            const ctx1 = document.getElementById('chart-ingresos').getContext('2d');
            if (window.chartIngresos) window.chartIngresos.destroy();
            window.chartIngresos = new Chart(ctx1, {
                type: 'bar',
                data: { labels: Object.keys(ingresosPorPropiedad), datasets: [{ data: Object.values(ingresosPorPropiedad), backgroundColor: ['#3498db','#e74c3c','#2ecc71','#9b59b6','#f39c12','#1abc9c','#e67e22','#34495e'] }] },
                options: { plugins: { legend: { display: false } } }
            });
            
            const ctx2 = document.getElementById('chart-origen').getContext('2d');
            if (window.chartOrigen) window.chartOrigen.destroy();
            window.chartOrigen = new Chart(ctx2, {
                type: 'doughnut',
                data: { labels: Object.keys(ingresosPorOrigen), datasets: [{ data: Object.values(ingresosPorOrigen), backgroundColor: ['#2ecc71','#9b59b6','#f1c40f','#1abc9c'] }] }
            });
        }
        
        function clearDashboardFilters() {
            document.getElementById('dash-filter-mes').value = '';
            document.getElementById('dash-filter-prop').value = '';
            document.getElementById('dash-filter-origen').value = '';
            applyDashboardFilters();
        }
        
        async function loadReportes() {
            // Cargar ingresos detalle
            const resIng = await fetch(`/api/ingresos-detalle/${currentYear}`);
            ingresosData = await resIng.json();
            filtrarIngresos();
            
            // Cargar gastos detalle
            const resGast = await fetch(`/api/gastos-detalle/${currentYear}`);
            gastosData = await resGast.json();
            filtrarGastosReporte();
            
            // Cargar resumen
            const resSum = await fetch(`/api/resumen/${currentYear}`);
            const data = await resSum.json();
            
            const porProp = {};
            const propsMensuales = new Set();
            
            // Ingresos temporarios
            data.ingresos.forEach(i => {
                if (!porProp[i.nombre]) porProp[i.nombre] = { ing: 0, noches: 0, propio: 0, terceros: 0, tipo: i.tipo };
                porProp[i.nombre].ing += i.total_ingresos;
                porProp[i.nombre].noches += i.noches;
                if (i.origen === 'Alquiler propio') porProp[i.nombre].propio += i.total_ingresos;
                else porProp[i.nombre].terceros += i.total_ingresos;
            });
            
            // Ingresos mensuales
            if (data.ingresos_mensuales) {
                data.ingresos_mensuales.forEach(i => {
                    propsMensuales.add(i.nombre);
                    if (!porProp[i.nombre]) porProp[i.nombre] = { ing: 0, noches: 0, propio: 0, terceros: 0, tipo: 'mensual', meses: i.meses };
                    porProp[i.nombre].ing += i.total_ingresos;
                    porProp[i.nombre].meses = i.meses;
                });
            }
            
            const gastosPorProp = {};
            data.gastos.forEach(g => {
                if (g.nombre) gastosPorProp[g.nombre] = (gastosPorProp[g.nombre] || 0) + g.total_gastos;
            });
            
            let html = '', totIng = 0, totGast = 0, totNoches = 0, totPropio = 0, totTerc = 0;
            const rentPorProp = {};
            let propsTemporarias = 0;
            
            for (const [nombre, d] of Object.entries(porProp)) {
                const gast = gastosPorProp[nombre] || 0;
                const rent = d.ing - gast;
                const esMensual = propsMensuales.has(nombre);
                const ticket = d.noches > 0 ? d.ing / d.noches : (esMensual && d.meses > 0 ? d.ing / d.meses : 0);
                const ocup = esMensual ? '-' : (d.noches / 365 * 100).toFixed(1) + '%';
                
                rentPorProp[nombre] = rent;
                totIng += d.ing; totGast += gast; 
                if (!esMensual) {
                    totNoches += d.noches;
                    propsTemporarias++;
                }
                totPropio += d.propio; totTerc += d.terceros;
                
                const nochesDisplay = esMensual ? `${d.meses || 0} meses` : d.noches;
                const ticketLabel = esMensual ? `$${ticket.toFixed(0)}/mes` : `$${ticket.toFixed(0)}`;
                
                html += `<tr>
                    <td>${nombre} ${esMensual ? 'üè¢' : ''}</td>
                    <td>$${d.ing.toLocaleString()}</td>
                    <td>$${gast.toLocaleString()}</td>
                    <td style="color:${rent >= 0 ? '#2ecc71' : '#e74c3c'}">$${rent.toLocaleString()}</td>
                    <td>${nochesDisplay}</td>
                    <td>${ocup}</td>
                    <td>${ticketLabel}</td>
                    <td>$${d.propio.toLocaleString()}</td>
                    <td>$${d.terceros.toLocaleString()}</td>
                </tr>`;
            }
            
            const ocupProm = propsTemporarias > 0 ? (totNoches / (365 * propsTemporarias) * 100).toFixed(1) : 0;
            
            html += `<tr class="total-row">
                <td>TOTAL</td>
                <td>$${totIng.toLocaleString()}</td>
                <td>$${(totGast + data.gastos_generales).toLocaleString()}</td>
                <td style="color:#2ecc71">$${(totIng - totGast - data.gastos_generales).toLocaleString()}</td>
                <td>${totNoches} noches</td>
                <td>${ocupProm}%</td>
                <td>$${totNoches > 0 ? (totIng / totNoches).toFixed(0) : 0}</td>
                <td>$${totPropio.toLocaleString()}</td>
                <td>$${totTerc.toLocaleString()}</td>
            </tr>`;
            
            document.getElementById('resumen-table').innerHTML = html;
            
            // Gr√°ficos resumen
            const ctx3 = document.getElementById('chart-rent').getContext('2d');
            if (window.chartRent) window.chartRent.destroy();
            window.chartRent = new Chart(ctx3, {
                type: 'bar',
                data: { labels: Object.keys(rentPorProp), datasets: [{ data: Object.values(rentPorProp), backgroundColor: Object.values(rentPorProp).map(v => v >= 0 ? '#2ecc71' : '#e74c3c') }] },
                options: { plugins: { legend: { display: false } } }
            });
            
            const ctx4 = document.getElementById('chart-dist').getContext('2d');
            if (window.chartDist) window.chartDist.destroy();
            window.chartDist = new Chart(ctx4, {
                type: 'doughnut',
                data: { labels: Object.keys(porProp), datasets: [{ data: Object.values(porProp).map(p => p.ing), backgroundColor: ['#3498db','#e74c3c','#2ecc71','#9b59b6','#f39c12','#1abc9c','#e67e22','#34495e'] }] }
            });
        }
        
        function filtrarIngresos() {
            const prop = document.getElementById('filter-prop').value;
            const origen = document.getElementById('filter-origen').value;
            const mes = document.getElementById('filter-mes').value;
            
            let filtered = ingresosData.filter(i => {
                if (prop && i.propiedad !== prop) return false;
                if (origen && i.origen !== origen) return false;
                if (mes && i.mes !== mes) return false;
                return true;
            });
            
            const total = filtered.reduce((a, b) => a + b.precio, 0);
            const noches = filtered.length;
            
            document.getElementById('sum-ingresos').textContent = '$' + total.toLocaleString();
            document.getElementById('sum-noches').textContent = noches;
            document.getElementById('sum-ticket').textContent = noches > 0 ? '$' + (total / noches).toFixed(0) : '$0';
            
            document.getElementById('ingresos-table').innerHTML = filtered.map(i => `
                <tr>
                    <td>${i.fecha}</td>
                    <td>${i.propiedad}</td>
                    <td>$${i.precio.toLocaleString()}</td>
                    <td><span class="badge badge-${i.origen.toLowerCase()}">${i.origen}</span></td>
                    <td>${i.notas || '-'}</td>
                </tr>
            `).join('');
        }
        
        function filtrarGastosReporte() {
            const prop = document.getElementById('filter-gasto-prop').value;
            const cat = document.getElementById('filter-gasto-cat').value;
            
            let filtered = gastosData.filter(g => {
                if (prop && g.propiedad !== prop) return false;
                if (cat && g.categoria !== cat) return false;
                return true;
            });
            
            const total = filtered.reduce((a, b) => a + b.monto, 0);
            document.getElementById('sum-gastos').textContent = '$' + total.toLocaleString();
            
            document.getElementById('gastos-reporte-table').innerHTML = filtered.map(g => `
                <tr>
                    <td>${g.fecha}</td>
                    <td>${g.propiedad}</td>
                    <td>${g.categoria}</td>
                    <td>$${g.monto.toLocaleString()}</td>
                    <td>${g.descripcion || '-'}</td>
                </tr>
            `).join('');
        }
        
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
        
        function exportarExcel() {
            // Abrir modal para seleccionar fechas
            const year = document.getElementById('yearSelect').value;
            document.getElementById('excel-desde').value = `${year}-01-01`;
            document.getElementById('excel-hasta').value = `${year}-12-31`;
            
            // Llenar selector de propiedades
            const selectProp = document.getElementById('excel-propiedad');
            selectProp.innerHTML = '<option value="">Todas</option>';
            propiedades.forEach(p => {
                selectProp.innerHTML += `<option value="${p.nombre}">${p.nombre}</option>`;
            });
            
            document.getElementById('excel-modal').classList.add('show');
        }
        
        function setExcelRangeYear() {
            const year = document.getElementById('yearSelect').value;
            document.getElementById('excel-desde').value = `${year}-01-01`;
            document.getElementById('excel-hasta').value = `${year}-12-31`;
        }
        
        document.getElementById('excel-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const desde = document.getElementById('excel-desde').value;
            const hasta = document.getElementById('excel-hasta').value;
            const propiedad = document.getElementById('excel-propiedad').value;
            
            let url = `/api/exportar/excel?desde=${desde}&hasta=${hasta}`;
            if (propiedad) url += `&propiedad=${encodeURIComponent(propiedad)}`;
            
            window.location.href = url;
            showToast('Descargando Excel...');
            closeModal('excel-modal');
        });
        
        function abrirPresentacion() {
            window.open(`/api/presentacion/${currentYear}`, '_blank');
        }
        
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.target.classList.add('active');
            if (section === 'gastos') loadGastos();
            if (section === 'reportes') loadReportes();
            if (section === 'calendario-general') loadCalendarioGeneral();
        }
        
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast show' + (type === 'error' ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('show'); });
        });
        
        // === CALENDARIO GENERAL ===
        let generalYear = 2025;
        let generalMonth = 12;
        const DEPTOS_TIDES = ['TIDES 14 B', 'TIDES 5 L', 'TIDES 10 L', 'TIDES 10 F', 'TIDES 12 F'];
        
        function changeMonthGeneral(delta) {
            generalMonth += delta;
            if (generalMonth > 12) { generalMonth = 1; generalYear++; }
            if (generalMonth < 1) { generalMonth = 12; generalYear--; }
            clearSelectionGeneral();
            loadCalendarioGeneral();
        }
        
        // Selecci√≥n en calendario general
        let selectedCellsGeneral = [];
        
        function toggleSelectGeneral(cell) {
            const fecha = cell.dataset.fecha;
            const prop = cell.dataset.prop;
            const propId = cell.dataset.propid;
            const key = `${prop}-${fecha}`;
            
            const idx = selectedCellsGeneral.findIndex(s => s.key === key);
            if (idx >= 0) {
                selectedCellsGeneral.splice(idx, 1);
                cell.classList.remove('selected');
            } else {
                selectedCellsGeneral.push({ key, fecha, prop, propId });
                cell.classList.add('selected');
            }
            updateSelectionBarGeneral();
        }
        
        function updateSelectionBarGeneral() {
            const bar = document.getElementById('selection-bar-general');
            const count = document.getElementById('selected-count-general');
            const btnCargar = document.getElementById('btn-cargar-general');
            const btnEliminar = document.getElementById('btn-eliminar-general');
            
            const totalLibres = selectedCellsGeneral.length;
            const totalRangos = selectedRangos.length;
            let totalDiasOcupados = 0;
            selectedRangos.forEach(r => totalDiasOcupados += r.fechas.length);
            
            if (totalLibres > 0 || totalRangos > 0) {
                bar.style.display = 'flex';
                
                // Mostrar resumen
                let texto = '';
                if (totalLibres > 0) texto += `${totalLibres} d√≠as libres`;
                if (totalLibres > 0 && totalRangos > 0) texto += ' + ';
                if (totalRangos > 0) texto += `${totalRangos} alquiler(es) (${totalDiasOcupados} d√≠as)`;
                count.textContent = texto;
                
                // Mostrar botones seg√∫n tipo de selecci√≥n
                btnCargar.style.display = totalLibres > 0 ? 'inline-block' : 'none';
                btnEliminar.style.display = totalRangos > 0 ? 'inline-block' : 'none';
            } else {
                bar.style.display = 'none';
            }
        }
        
        function clearSelectionGeneral() {
            selectedCellsGeneral = [];
            selectedRangos = [];
            document.querySelectorAll('#tabla-general td.selected').forEach(c => c.classList.remove('selected'));
            updateSelectionBarGeneral();
        }
        
        // Selecci√≥n de rangos ocupados (alquileres completos)
        let selectedRangos = [];
        
        function toggleSelectRango(cell, rangoDataEncoded) {
            const rangoData = JSON.parse(decodeURIComponent(rangoDataEncoded));
            const key = `${rangoData.prop}-${rangoData.fechas[0]}`;
            
            const idx = selectedRangos.findIndex(r => r.key === key);
            if (idx >= 0) {
                selectedRangos.splice(idx, 1);
                cell.classList.remove('selected');
            } else {
                selectedRangos.push({ 
                    key, 
                    propId: rangoData.propId, 
                    prop: rangoData.prop,
                    fechas: rangoData.fechas,
                    inquilino: rangoData.inquilino,
                    origen: rangoData.origen
                });
                cell.classList.add('selected');
            }
            updateSelectionBarGeneral();
        }
        
        async function eliminarSeleccionGeneral() {
            if (selectedRangos.length === 0) return;
            
            // Contar total de d√≠as
            let totalDias = 0;
            selectedRangos.forEach(r => totalDias += r.fechas.length);
            
            if (!confirm(`¬øSeguro que quer√©s eliminar ${selectedRangos.length} alquiler(es) (${totalDias} d√≠as en total)?`)) return;
            
            for (const rango of selectedRangos) {
                for (const fecha of rango.fechas) {
                    await fetch(`/api/ocupacion/${rango.propId}/${fecha}`, { method: 'DELETE' });
                }
            }
            
            showToast(`Se eliminaron ${totalDias} d√≠as`, 'success');
            clearSelectionGeneral();
            loadCalendarioGeneral();
            loadAll();
        }
        
        function openMultiModalGeneral() {
            if (selectedCellsGeneral.length === 0) return;
            
            // Agrupar por propiedad
            const grouped = {};
            selectedCellsGeneral.forEach(s => {
                if (!grouped[s.prop]) grouped[s.prop] = { propId: s.propId, fechas: [] };
                grouped[s.prop].fechas.push(s.fecha);
            });
            
            // Mostrar resumen
            const props = Object.keys(grouped);
            let resumen = `<strong>Se cargar√°n ${selectedCellsGeneral.length} d√≠as:</strong><br>`;
            props.forEach(p => {
                const fechas = grouped[p].fechas.sort();
                resumen += `‚Ä¢ ${p}: ${fechas.length} noches<br>`;
            });
            
            document.getElementById('multi-resumen').innerHTML = resumen;
            
            // Limpiar formulario (mantener origen como "Alquiler propio")
            document.getElementById('multi-precio').value = '';
            document.getElementById('multi-notas').value = '';
            document.getElementById('multi-origen').value = 'Alquiler propio';
            
            document.getElementById('multi-general-modal').classList.add('show');
            
            // Guardar info para submit
            window.pendingMultiGeneral = grouped;
        }
        
        async function submitMultiGeneral() {
            const precio = parseFloat(document.getElementById('multi-precio').value);
            const origen = document.getElementById('multi-origen').value || 'Alquiler propio';
            const notas = document.getElementById('multi-notas').value;
            
            if (!precio || precio <= 0) { showToast('Ingres√° un precio v√°lido', 'error'); return; }
            
            let total = 0;
            for (const prop of Object.keys(window.pendingMultiGeneral)) {
                const data = window.pendingMultiGeneral[prop];
                for (const fecha of data.fechas) {
                    await fetch('/api/ocupacion', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            propiedad_id: data.propId,
                            fecha: fecha,
                            precio: precio,
                            origen: origen,
                            notas: notas
                        })
                    });
                    total++;
                }
            }
            
            document.getElementById('multi-general-modal').classList.remove('show');
            clearSelectionGeneral();
            loadCalendarioGeneral();
            loadAll();
            showToast(`Se cargaron ${total} noches correctamente`, 'success');
        }
        
        async function loadCalendarioGeneral() {
            const monthNames = ['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            document.getElementById('calendar-month-general').textContent = `${monthNames[generalMonth]} ${generalYear}`;
            
            // Obtener ocupaciones del mes
            const res = await fetch(`/api/ocupaciones/${generalYear}/${generalMonth}`);
            const ocupaciones = await res.json();
            
            // Crear mapa de ocupaciones
            const ocupMap = {};
            ocupaciones.forEach(o => {
                const key = `${o.propiedad_nombre}-${o.fecha}`;
                ocupMap[key] = o;
            });
            
            // Obtener d√≠as del mes
            const diasEnMes = new Date(generalYear, generalMonth, 0).getDate();
            
            // Crear header
            let headerHtml = '<tr><th style="min-width:100px">Propiedad</th>';
            for (let d = 1; d <= diasEnMes; d++) {
                const fecha = new Date(generalYear, generalMonth - 1, d);
                const diaSemana = ['D','L','M','X','J','V','S'][fecha.getDay()];
                headerHtml += `<th class="dia-header">${d}<br><small>${diaSemana}</small></th>`;
            }
            headerHtml += '</tr>';
            document.getElementById('tabla-general-header').innerHTML = headerHtml;
            
            // Crear filas por cada departamento con celdas combinadas
            let bodyHtml = '';
            DEPTOS_TIDES.forEach(depto => {
                const propId = propiedades.find(p => p.nombre === depto)?.id;
                bodyHtml += `<tr><td class="prop-name">${depto}</td>`;
                
                let d = 1;
                while (d <= diasEnMes) {
                    const fechaStr = `${generalYear}-${String(generalMonth).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const key = `${depto}-${fechaStr}`;
                    const ocup = ocupMap[key];
                    
                    if (!ocup) {
                        // Celda libre - clickeable
                        bodyHtml += `<td class="dia-cell libre" data-fecha="${fechaStr}" data-prop="${depto}" data-propid="${propId}" onclick="toggleSelectGeneral(this)" title="Click para cargar"><span style="font-size:0.65rem;font-weight:600">LIBRE</span></td>`;
                        d++;
                    } else {
                        // Celda ocupada - buscar cu√°ntos d√≠as seguidos tiene el mismo inquilino
                        const inquilinoActual = ocup.notas || '';
                        const origenActual = ocup.origen || '';
                        let colspan = 1;
                        let precioTotal = ocup.precio || 0;
                        
                        // Buscar d√≠as consecutivos con mismo inquilino y origen
                        for (let siguiente = d + 1; siguiente <= diasEnMes; siguiente++) {
                            const fechaSig = `${generalYear}-${String(generalMonth).padStart(2,'0')}-${String(siguiente).padStart(2,'0')}`;
                            const keySig = `${depto}-${fechaSig}`;
                            const ocupSig = ocupMap[keySig];
                            
                            if (ocupSig && ocupSig.notas === inquilinoActual && ocupSig.origen === origenActual) {
                                colspan++;
                                precioTotal += ocupSig.precio || 0;
                            } else {
                                break;
                            }
                        }
                        
                        const origenLower = origenActual.toLowerCase();
                        let clase = 'dia-cell ocupado';
                        let origenTexto = origenActual.toUpperCase();
                        
                        if (origenLower === 'alquiler propio') {
                            clase = 'dia-cell ocupado-due√±o';
                        } else if (origenLower === 'alicia') {
                            clase = 'dia-cell ocupado-alicia';
                        } else if (origenLower === 'estanislao') {
                            clase = 'dia-cell ocupado-estanislao';
                        }
                        
                        const titulo = `${origenActual}: ${inquilinoActual || 'Sin nombre'} - $${precioTotal} (${colspan} noches)`;
                        const precioPorNoche = ocup.precio || 0;
                        const contenido = `<div class="celda-info-merged">
                            <span class="merged-inquilino">${inquilinoActual || origenTexto}</span>
                            <span class="merged-detalle">${origenTexto} ¬∑ ${colspan} noches x $${precioPorNoche}</span>
                        </div>`;
                        
                        // Guardar todas las fechas del rango para eliminar
                        const fechasRango = [];
                        for (let i = 0; i < colspan; i++) {
                            const diaRango = d + i;
                            fechasRango.push(`${generalYear}-${String(generalMonth).padStart(2,'0')}-${String(diaRango).padStart(2,'0')}`);
                        }
                        const rangoData = encodeURIComponent(JSON.stringify({
                            propId: propId,
                            prop: depto,
                            fechas: fechasRango,
                            inquilino: inquilinoActual,
                            origen: origenActual
                        }));
                        
                        bodyHtml += `<td class="${clase}" colspan="${colspan}" title="${titulo}" style="cursor:pointer" data-ocupado="true" onclick="toggleSelectRango(this, '${rangoData}')">${contenido}</td>`;
                        d += colspan;
                    }
                }
                bodyHtml += '</tr>';
            });
            
            document.getElementById('tabla-general-body').innerHTML = bodyHtml;
        }
        
        // === IMPORTAR EXCEL ===
        let importOrigen = null;
        
        function openImportModal() {
            document.getElementById('import-file').value = '';
            document.getElementById('import-result').style.display = 'none';
            document.querySelectorAll('#import-modal .origen-btn').forEach(b => b.classList.remove('selected'));
            importOrigen = null;
            document.getElementById('import-modal').classList.add('show');
        }
        
        function selectImportOrigen(btn) {
            document.querySelectorAll('#import-modal .origen-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            importOrigen = btn.dataset.origen;
        }
        
        document.getElementById('import-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!importOrigen) {
                showToast('Seleccion√° qui√©n carg√≥ los alquileres', 'error');
                return;
            }
            
            const fileInput = document.getElementById('import-file');
            if (!fileInput.files.length) {
                showToast('Seleccion√° un archivo', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('origen', importOrigen);
            
            try {
                const res = await fetch('/api/importar-excel', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                
                const resultDiv = document.getElementById('import-result');
                const resultContent = document.getElementById('import-result-content');
                
                if (data.success) {
                    document.getElementById('import-result-title').textContent = '‚úÖ Importaci√≥n exitosa';
                    let html = `<div class="summary-row"><span class="summary-label">Registros importados:</span><span class="summary-value positive">${data.importados}</span></div>`;
                    
                    if (data.errores && data.errores.length > 0) {
                        html += `<div style="margin-top:15px;color:#e74c3c"><strong>‚ö†Ô∏è Errores (${data.errores.length}):</strong><ul style="margin-top:5px;padding-left:20px">`;
                        data.errores.slice(0, 5).forEach(err => {
                            html += `<li style="font-size:0.85rem">${err}</li>`;
                        });
                        if (data.errores.length > 5) html += `<li>...y ${data.errores.length - 5} m√°s</li>`;
                        html += '</ul></div>';
                    }
                    
                    resultContent.innerHTML = html;
                    showToast(`${data.importados} registros importados ‚úì`);
                    loadAll();
                } else {
                    document.getElementById('import-result-title').textContent = '‚ùå Error';
                    resultContent.innerHTML = `<div style="color:#e74c3c">${data.error}</div>`;
                    showToast('Error al importar', 'error');
                }
                
                resultDiv.style.display = 'block';
            } catch (err) {
                showToast('Error de conexi√≥n', 'error');
            }
        });
        
        // === ALQUILERES MENSUALES ===
        
        async function loadAlquileresMensuales() {
            const year = document.getElementById('mensual-year').value;
            const res = await fetch(`/api/alquileres-mensuales/${year}`);
            const data = await res.json();
            
            // Filtrar por la propiedad seleccionada
            alquileresMensualesData = data.filter(a => a.propiedad_id === selectedProperty);
            
            let total = 0;
            let html = '';
            
            // Crear una fila por cada mes cargado
            for (let mes = 1; mes <= 12; mes++) {
                const alquiler = alquileresMensualesData.find(a => a.mes === mes);
                if (alquiler) {
                    total += alquiler.monto;
                    html += `<tr>
                        <td>${MESES[mes]}</td>
                        <td style="color:#2ecc71;font-weight:600">$${alquiler.monto.toLocaleString()}</td>
                        <td>${alquiler.notas || '-'}</td>
                        <td>
                            <button class="btn btn-danger" onclick="eliminarAlquilerMensual(${mes})" style="padding:5px 10px;font-size:0.8rem">üóëÔ∏è</button>
                        </td>
                    </tr>`;
                } else {
                    html += `<tr style="opacity:0.5">
                        <td>${MESES[mes]}</td>
                        <td>-</td>
                        <td>-</td>
                        <td>
                            <button class="btn btn-secondary" onclick="openMensualModalForMonth(${mes})" style="padding:5px 10px;font-size:0.8rem">+ Agregar</button>
                        </td>
                    </tr>`;
                }
            }
            
            document.getElementById('mensual-table').innerHTML = html;
            document.getElementById('mensual-total').textContent = '$' + total.toLocaleString();
            document.getElementById('mensual-meses').textContent = alquileresMensualesData.length + ' de 12';
        }
        
        function openMensualModal() {
            document.getElementById('mensual-mes').value = new Date().getMonth() + 1;
            document.getElementById('mensual-monto').value = '';
            document.getElementById('mensual-notas').value = '';
            document.getElementById('mensual-modal').classList.add('show');
        }
        
        function openMensualModalForMonth(mes) {
            document.getElementById('mensual-mes').value = mes;
            document.getElementById('mensual-monto').value = '';
            document.getElementById('mensual-notas').value = '';
            document.getElementById('mensual-modal').classList.add('show');
        }
        
        document.getElementById('mensual-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const year = parseInt(document.getElementById('mensual-year').value);
            const mes = parseInt(document.getElementById('mensual-mes').value);
            const monto = parseFloat(document.getElementById('mensual-monto').value);
            const notas = document.getElementById('mensual-notas').value;
            
            const res = await fetch('/api/alquiler-mensual', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ propiedad_id: selectedProperty, a√±o: year, mes, monto, notas })
            });
            
            if (res.ok) {
                showToast('Alquiler guardado ‚úì');
                closeModal('mensual-modal');
                loadAlquileresMensuales();
                loadAll();
            }
        });
        
        async function eliminarAlquilerMensual(mes) {
            if (!confirm(`¬øEliminar ${MESES[mes]}?`)) return;
            const anio = document.getElementById('mensual-year').value;
            await fetch(`/api/alquiler-mensual/${selectedProperty}/${anio}/${mes}`, {method: 'DELETE'});
            showToast('Eliminado');
            loadAlquileresMensuales();
            loadAll();
        }
    </script>
</body>
</html>
