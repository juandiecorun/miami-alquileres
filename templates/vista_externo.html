<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè† Vista General - {{ nombre }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 25px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .logo { font-size: 1.5rem; font-weight: 700; color: #4ecdc4; }
        
        .badge {
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
        }
        .badge-alicia { background: rgba(155,89,182,0.3); color: #9b59b6; }
        .badge-estanislao { background: rgba(241,196,15,0.3); color: #f1c40f; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
            font-weight: 500;
        }
        .tab:hover { background: rgba(255,255,255,0.1); }
        .tab.active { background: rgba(78,205,196,0.2); border-color: #4ecdc4; color: #4ecdc4; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .calendar { overflow-x: auto; }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav-btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, rgba(78,205,196,0.2), rgba(78,205,196,0.1));
            color: #4ecdc4;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        .calendar-nav-btn:hover {
            background: linear-gradient(135deg, rgba(78,205,196,0.4), rgba(78,205,196,0.2));
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(78,205,196,0.3);
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .legend-color { width: 24px; height: 24px; border-radius: 6px; }
        
        .help-text {
            background: rgba(78,205,196,0.1);
            border: 1px solid rgba(78,205,196,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        /* Tabla calendario */
        #tabla-general { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        #tabla-general th, #tabla-general td {
            padding: 6px 3px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.05);
            vertical-align: middle;
        }
        #tabla-general th {
            background: rgba(78,205,196,0.15);
            color: #4ecdc4;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        #tabla-general th.dia-header { min-width: 70px; font-size: 0.8rem; }
        #tabla-general td.prop-name {
            text-align: left;
            padding: 12px 15px;
            font-weight: 700;
            background: rgba(0,0,0,0.3);
            white-space: nowrap;
            position: sticky;
            left: 0;
            z-index: 10;
            color: #4ecdc4;
            font-size: 0.9rem;
        }
        #tabla-general td.dia-cell {
            cursor: pointer;
            transition: all 0.2s;
            height: 60px;
            font-size: 0.7rem;
            line-height: 1.2;
        }
        #tabla-general td[colspan] {
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        #tabla-general td.dia-cell:hover { box-shadow: inset 0 0 0 2px #fff; }
        #tabla-general td.libre {
            background: rgba(0,0,0,0.3);
            border: 2px dashed rgba(46,204,113,0.4) !important;
            color: rgba(46,204,113,0.6);
            cursor: pointer;
        }
        #tabla-general td.libre:hover {
            background: rgba(46,204,113,0.15);
            border-color: rgba(46,204,113,0.8) !important;
        }
        #tabla-general td.libre.selected {
            background: rgba(46,204,113,0.3);
            border-color: #2ecc71 !important;
            box-shadow: inset 0 0 0 2px #2ecc71;
        }
        #tabla-general td.selected:not(.libre) {
            box-shadow: inset 0 0 0 3px #e74c3c !important;
            opacity: 0.8;
        }
        #tabla-general td.ocupado-due√±o {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: #fff;
            font-weight: 600;
        }
        #tabla-general td.ocupado-alicia {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: #fff;
            font-weight: 600;
        }
        #tabla-general td.ocupado-estanislao {
            background: linear-gradient(135deg, #f39c12, #f1c40f);
            color: #000;
            font-weight: 600;
        }
        #tabla-general td.ocupado {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            color: #fff;
            font-weight: 600;
        }
        
        .celda-info-merged {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 4px;
        }
        .merged-inquilino {
            font-size: 0.85rem;
            font-weight: 700;
            text-align: center;
            line-height: 1.2;
        }
        .merged-detalle {
            font-size: 0.65rem;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        .selection-bar {
            background: rgba(78,205,196,0.2);
            border: 1px solid #4ecdc4;
            border-radius: 10px;
            padding: 15px 20px;
            margin-top: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
        }
        .selection-bar.show { display: flex; }
        .selection-bar .count { font-weight: 600; color: #4ecdc4; }
        .selection-bar .actions { display: flex; gap: 10px; }
        
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary { background: #4ecdc4; color: #0d1b2a; }
        .btn-primary:hover { background: #3dbdb5; transform: translateY(-2px); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #1e3a5f;
            border-radius: 20px;
            padding: 30px;
            width: 450px;
            max-width: 90%;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 { font-size: 1.3rem; }
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #8892b0; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 1rem;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4ecdc4;
        }
        
        .origen-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        .origen-btn {
            padding: 20px 15px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.2);
            background: transparent;
            color: white;
            cursor: pointer;
            text-align: center;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .origen-btn:hover { border-color: rgba(255,255,255,0.4); }
        .origen-btn.selected { border-width: 3px; }
        .origen-btn.alicia.selected { border-color: #9b59b6; background: rgba(155,89,182,0.2); }
        .origen-btn.estanislao.selected { border-color: #f1c40f; background: rgba(241,196,15,0.2); }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: #2ecc71;
            color: white;
            display: none;
            z-index: 2000;
        }
        .toast.show { display: block; animation: slideIn 0.3s; }
        .toast.error { background: #e74c3c; }
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Formulario nueva carga */
        .form-card { margin-bottom: 20px; }
        .date-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .carga-item {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .carga-info { flex: 1; }
        .carga-info .prop { font-weight: 600; color: #4ecdc4; }
        .carga-info .fecha { color: #8892b0; font-size: 0.85rem; }
        .carga-info .inq { color: #fff; font-size: 0.9rem; margin-top: 5px; }
        .carga-precio { color: #2ecc71; font-weight: 600; font-size: 1.1rem; }
        .carga-actions { display: flex; gap: 5px; }
        .btn-edit { background: #3498db; color: white; padding: 8px 15px; font-size: 0.85rem; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .empty { text-align: center; color: #8892b0; padding: 30px; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <div class="logo">üè† Miami - Vista General</div>
            <div class="badge badge-{{ nombre.lower() }}">{{ nombre }}</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('calendario')">üóìÔ∏è Ver Calendario</div>
            <div class="tab" onclick="showTab('cargar')">‚ûï Nueva Carga</div>
            <div class="tab" onclick="showTab('mis')">üìã Mis Cargas</div>
        </div>
        
        <!-- Tab Calendario -->
        <div id="tab-calendario" class="tab-content active">
            <div class="card calendar">
                <div class="help-text">
                    üí° <strong>Tip:</strong> Mir√° qu√© d√≠as est√°n disponibles. Las celdas <span style="color:#2ecc71">verdes</span> son Alquiler propio, 
                    <span style="color:#9b59b6">violetas</span> son de Alicia, <span style="color:#f1c40f">amarillas</span> son de Estanislao.
                    <br><strong>Para cargar:</strong> And√° a la pesta√±a "Nueva Carga" o hac√© click en las celdas LIBRE y despu√©s "Cargar selecci√≥n".
                </div>
                
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="changeMonth(-1)">‚óÄ Anterior</button>
                    <h2 id="calendar-month" style="color:#4ecdc4">Diciembre 2025</h2>
                    <button class="calendar-nav-btn" onclick="changeMonth(1)">Siguiente ‚ñ∂</button>
                </div>
                
                <div class="legend">
                    <div class="legend-item"><div class="legend-color" style="background:#1a1a2e;border:2px dashed rgba(46,204,113,0.5)"></div><span>LIBRE</span></div>
                    <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#27ae60,#2ecc71)"></div><span>Alquiler propio</span></div>
                    <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#8e44ad,#9b59b6)"></div><span>Alicia</span></div>
                    <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#f39c12,#f1c40f)"></div><span>Estanislao</span></div>
                </div>
                
                <table id="tabla-general">
                    <thead id="tabla-general-header"></thead>
                    <tbody id="tabla-general-body"></tbody>
                </table>
                
                <div class="selection-bar" id="selection-bar">
                    <span><span class="count" id="selected-count">0</span> d√≠as seleccionados</span>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="clearSelection()">Cancelar</button>
                        <button class="btn btn-primary" onclick="openMultiModal()">Cargar selecci√≥n</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab Nueva Carga -->
        <div id="tab-cargar" class="tab-content">
            <div class="card form-card">
                <h2 style="color:#4ecdc4;margin-bottom:20px">‚ûï Cargar Nuevo Alquiler</h2>
                
                <form id="cargar-form">
                    <div class="form-group">
                        <label>üè¢ Propiedad</label>
                        <select id="propiedad" required>
                            <option value="">Seleccionar...</option>
                            <option value="TIDES 14 B">TIDES 14 B</option>
                            <option value="TIDES 5 L">TIDES 5 L</option>
                            <option value="TIDES 10 L">TIDES 10 L</option>
                            <option value="TIDES 10 F">TIDES 10 F</option>
                            <option value="TIDES 12 F">TIDES 12 F</option>
                        </select>
                    </div>
                    
                    <div class="date-row">
                        <div class="form-group">
                            <label>üìÖ Check-in</label>
                            <input type="date" id="fecha-inicio" required>
                        </div>
                        <div class="form-group">
                            <label>üìÖ Check-out</label>
                            <input type="date" id="fecha-fin" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>üíµ Precio por noche (USD)</label>
                        <input type="number" id="precio" placeholder="150" min="0" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label>üë§ Nombre del inquilino</label>
                        <input type="text" id="inquilino" placeholder="Ej: Juan Perez" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width:100%">‚úÖ Guardar Alquiler</button>
                </form>
            </div>
        </div>
        
        <!-- Tab Mis Cargas -->
        <div id="tab-mis" class="tab-content">
            <div class="card">
                <h2 style="color:#4ecdc4;margin-bottom:20px">üìã Mis Cargas</h2>
                <div id="lista-cargas">
                    <div class="empty">Cargando...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Cargar Selecci√≥n -->
    <div class="modal" id="multi-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìù Cargar Ocupaci√≥n</h3>
                <button class="modal-close" onclick="closeModal('multi-modal')">&times;</button>
            </div>
            
            <div id="multi-resumen" style="background:rgba(0,0,0,0.3);padding:15px;border-radius:10px;margin-bottom:20px;font-size:0.9rem"></div>
            
            <div class="form-group">
                <label>üíµ Precio por noche (USD)</label>
                <input type="number" id="multi-precio" placeholder="200" required>
            </div>
            
            <div class="form-group">
                <label>üë§ Nombre del inquilino</label>
                <input type="text" id="multi-notas" placeholder="Ej: Mar√≠a Garc√≠a" required>
            </div>
            
            <button class="btn btn-primary" style="width:100%" onclick="submitMulti()">‚úÖ Guardar</button>
        </div>
    </div>
    
    <!-- Modal Editar -->
    <div class="modal" id="modal-edit">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Carga</h3>
                <button class="modal-close" onclick="closeModal('modal-edit')">&times;</button>
            </div>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label>üíµ Precio por noche (USD)</label>
                    <input type="number" id="edit-precio" required>
                </div>
                <div class="form-group">
                    <label>üë§ Inquilino</label>
                    <input type="text" id="edit-inquilino" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">üíæ Guardar Cambios</button>
            </form>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        const ORIGEN = '{{ nombre }}';
        const DEPTOS_TIDES = ['TIDES 14 B', 'TIDES 5 L', 'TIDES 10 L', 'TIDES 10 F', 'TIDES 12 F'];
        
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let propiedades = [];
        let selectedCells = [];
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', async () => {
            await loadPropiedades();
            loadCalendario();
        });
        
        async function loadPropiedades() {
            const res = await fetch('/api/propiedades');
            propiedades = await res.json();
        }
        
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            const tabIndex = tab === 'calendario' ? 0 : (tab === 'cargar' ? 1 : 2);
            document.querySelectorAll('.tab')[tabIndex].classList.add('active');
            document.getElementById('tab-' + tab).classList.add('active');
            
            if (tab === 'mis') cargarMisCargas();
            if (tab === 'calendario') loadCalendario();
        }
        
        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 12) { currentMonth = 1; currentYear++; }
            if (currentMonth < 1) { currentMonth = 12; currentYear--; }
            clearSelection();
            loadCalendario();
        }
        
        async function loadCalendario() {
            const monthNames = ['','Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            document.getElementById('calendar-month').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const res = await fetch(`/api/ocupaciones/${currentYear}/${currentMonth}`);
            const ocupaciones = await res.json();
            
            // Crear mapa de ocupaciones
            const ocupMap = {};
            ocupaciones.forEach(o => {
                const key = `${o.propiedad_nombre}-${o.fecha}`;
                ocupMap[key] = o;
            });
            
            const diasEnMes = new Date(currentYear, currentMonth, 0).getDate();
            
            // Header
            let headerHtml = '<tr><th style="min-width:100px">Propiedad</th>';
            for (let d = 1; d <= diasEnMes; d++) {
                const fecha = new Date(currentYear, currentMonth - 1, d);
                const diaSemana = ['D','L','M','X','J','V','S'][fecha.getDay()];
                headerHtml += `<th class="dia-header">${d}<br><small>${diaSemana}</small></th>`;
            }
            headerHtml += '</tr>';
            document.getElementById('tabla-general-header').innerHTML = headerHtml;
            
            // Body
            let bodyHtml = '';
            DEPTOS_TIDES.forEach(depto => {
                const propId = propiedades.find(p => p.nombre === depto)?.id;
                bodyHtml += `<tr><td class="prop-name">${depto}</td>`;
                
                let d = 1;
                while (d <= diasEnMes) {
                    const fechaStr = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const key = `${depto}-${fechaStr}`;
                    const ocup = ocupMap[key];
                    
                    if (!ocup) {
                        bodyHtml += `<td class="dia-cell libre" data-fecha="${fechaStr}" data-prop="${depto}" data-propid="${propId}" onclick="toggleSelect(this)"><span style="font-size:0.65rem;font-weight:600">LIBRE</span></td>`;
                        d++;
                    } else {
                        const inquilinoActual = ocup.notas || '';
                        const origenActual = ocup.origen || '';
                        let colspan = 1;
                        
                        for (let siguiente = d + 1; siguiente <= diasEnMes; siguiente++) {
                            const fechaSig = `${currentYear}-${String(currentMonth).padStart(2,'0')}-${String(siguiente).padStart(2,'0')}`;
                            const keySig = `${depto}-${fechaSig}`;
                            const ocupSig = ocupMap[keySig];
                            
                            if (ocupSig && ocupSig.notas === inquilinoActual && ocupSig.origen === origenActual) {
                                colspan++;
                            } else {
                                break;
                            }
                        }
                        
                        const origenLower = origenActual.toLowerCase();
                        let clase = 'dia-cell ocupado';
                        let origenTexto = origenActual.toUpperCase();
                        
                        if (origenLower === 'alquiler propio') {
                            clase = 'dia-cell ocupado-due√±o';
                        } else if (origenLower === 'alicia') {
                            clase = 'dia-cell ocupado-alicia';
                        } else if (origenLower === 'estanislao') {
                            clase = 'dia-cell ocupado-estanislao';
                        }
                        
                        const precioPorNoche = ocup.precio || 0;
                        const contenido = `<div class="celda-info-merged">
                            <span class="merged-inquilino">${inquilinoActual || origenTexto}</span>
                            <span class="merged-detalle">${origenTexto} ¬∑ ${colspan} noches x $${precioPorNoche}</span>
                        </div>`;
                        
                        bodyHtml += `<td class="${clase}" colspan="${colspan}" title="${inquilinoActual || origenActual}">${contenido}</td>`;
                        d += colspan;
                    }
                }
                bodyHtml += '</tr>';
            });
            
            document.getElementById('tabla-general-body').innerHTML = bodyHtml;
        }
        
        // Selecci√≥n de celdas
        function toggleSelect(cell) {
            const fecha = cell.dataset.fecha;
            const prop = cell.dataset.prop;
            const propId = cell.dataset.propid;
            const key = `${prop}-${fecha}`;
            
            const idx = selectedCells.findIndex(s => s.key === key);
            if (idx >= 0) {
                selectedCells.splice(idx, 1);
                cell.classList.remove('selected');
            } else {
                selectedCells.push({ key, fecha, prop, propId });
                cell.classList.add('selected');
            }
            updateSelectionBar();
        }
        
        function updateSelectionBar() {
            const bar = document.getElementById('selection-bar');
            const count = document.getElementById('selected-count');
            
            if (selectedCells.length > 0) {
                bar.style.display = 'flex';
                count.textContent = selectedCells.length;
            } else {
                bar.style.display = 'none';
            }
        }
        
        function clearSelection() {
            selectedCells = [];
            document.querySelectorAll('#tabla-general td.selected').forEach(c => c.classList.remove('selected'));
            updateSelectionBar();
        }
        
        function openMultiModal() {
            if (selectedCells.length === 0) return;
            
            const grouped = {};
            selectedCells.forEach(s => {
                if (!grouped[s.prop]) grouped[s.prop] = { propId: s.propId, fechas: [] };
                grouped[s.prop].fechas.push(s.fecha);
            });
            
            const props = Object.keys(grouped);
            let resumen = `<strong>Se cargar√°n ${selectedCells.length} d√≠as como ${ORIGEN}:</strong><br>`;
            props.forEach(p => {
                const fechas = grouped[p].fechas.sort();
                resumen += `‚Ä¢ ${p}: ${fechas.length} noches<br>`;
            });
            
            document.getElementById('multi-resumen').innerHTML = resumen;
            document.getElementById('multi-precio').value = '';
            document.getElementById('multi-notas').value = '';
            document.getElementById('multi-modal').classList.add('show');
            
            window.pendingMulti = grouped;
        }
        
        async function submitMulti() {
            const precio = parseFloat(document.getElementById('multi-precio').value);
            const notas = document.getElementById('multi-notas').value;
            
            if (!precio || precio <= 0) { showToast('Ingres√° un precio v√°lido', 'error'); return; }
            if (!notas.trim()) { showToast('Ingres√° el nombre del inquilino', 'error'); return; }
            
            let total = 0;
            for (const prop of Object.keys(window.pendingMulti)) {
                const data = window.pendingMulti[prop];
                for (const fecha of data.fechas) {
                    await fetch('/api/ocupacion', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            propiedad_id: data.propId,
                            fecha: fecha,
                            precio: precio,
                            origen: ORIGEN,
                            notas: notas
                        })
                    });
                    total++;
                }
            }
            
            closeModal('multi-modal');
            clearSelection();
            loadCalendario();
            showToast(`Se cargaron ${total} noches correctamente`, 'success');
        }
        
        // Formulario nueva carga
        document.getElementById('cargar-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const propiedad = document.getElementById('propiedad').value;
            const fechaInicio = document.getElementById('fecha-inicio').value;
            const fechaFin = document.getElementById('fecha-fin').value;
            const precio = parseFloat(document.getElementById('precio').value);
            const inquilino = document.getElementById('inquilino').value;
            
            const res = await fetch('/api/cargar-externo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    propiedad: propiedad,
                    fecha_inicio: fechaInicio,
                    fecha_fin: fechaFin,
                    precio: precio,
                    inquilino: inquilino,
                    origen: ORIGEN
                })
            });
            
            const result = await res.json();
            
            if (result.success) {
                showToast(`Se cargaron ${result.dias} noche(s)`);
                document.getElementById('cargar-form').reset();
                loadCalendario();
            } else {
                showToast(result.error || 'Error al guardar', 'error');
            }
        });
        
        // Mis cargas
        async function cargarMisCargas() {
            const res = await fetch('/api/mis-cargas/' + ORIGEN);
            const cargas = await res.json();
            const lista = document.getElementById('lista-cargas');
            
            if (cargas.length === 0) {
                lista.innerHTML = '<div class="empty">No ten√©s cargas todav√≠a</div>';
                return;
            }
            
            lista.innerHTML = cargas.map(c => `
                <div class="carga-item">
                    <div class="carga-info">
                        <span class="prop">${c.propiedad}</span>
                        <span class="fecha">${c.fecha}</span>
                        <div class="inq">üë§ ${c.notas || 'Sin nombre'}</div>
                    </div>
                    <span class="carga-precio">$${c.precio}</span>
                    <div class="carga-actions">
                        <button class="btn btn-edit btn-sm" onclick="editarCarga(${c.id}, ${c.precio}, '${(c.notas || '').replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="borrarCarga(${c.id})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }
        
        function editarCarga(id, precio, inquilino) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-precio').value = precio;
            document.getElementById('edit-inquilino').value = inquilino;
            document.getElementById('modal-edit').classList.add('show');
        }
        
        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const res = await fetch('/api/modificar-carga/' + id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    precio: parseFloat(document.getElementById('edit-precio').value),
                    inquilino: document.getElementById('edit-inquilino').value,
                    origen: ORIGEN
                })
            });
            const data = await res.json();
            if (data.success) {
                closeModal('modal-edit');
                cargarMisCargas();
                loadCalendario();
                showToast('Carga actualizada');
            } else {
                showToast(data.error || 'Error al modificar', 'error');
            }
        });
        
        async function borrarCarga(id) {
            if (!confirm('¬øSeguro que quer√©s borrar esta carga?')) return;
            const res = await fetch('/api/borrar-carga/' + id + '/' + ORIGEN, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) {
                cargarMisCargas();
                loadCalendario();
                showToast('Carga eliminada');
            } else {
                showToast(data.error || 'Error al borrar', 'error');
            }
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }
        
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast show' + (type === 'error' ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('show'); });
        });
    </script>
</body>
</html>
